<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EA Business Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü§ñ</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      min-height: 100vh;
      background: #0a0a0f;
      font-family: 'IBM Plex Sans', -apple-system, sans-serif;
      color: #e6edf3;
      padding: 24px 16px;
    }
    
    .container { max-width: 1100px; margin: 0 auto; }
    
    /* Header */
    .header { text-align: center; margin-bottom: 32px; }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 255, 65, 0.1);
      border: 1px solid rgba(0, 255, 65, 0.2);
      border-radius: 100px;
      padding: 8px 20px;
      margin-bottom: 16px;
      font-size: 13px;
      font-weight: 500;
      color: #00FF41;
    }
    
    h1 {
      font-size: clamp(24px, 4vw, 36px);
      font-weight: 700;
      background: linear-gradient(135deg, #fff 0%, #a8a8a8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle { font-size: 14px; color: rgba(255,255,255,0.5); margin-top: 8px; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 16px;
    }
    
    .tab {
      padding: 12px 24px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 8px;
      color: rgba(255,255,255,0.6);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab:hover { background: rgba(255,255,255,0.06); }
    .tab.active { 
      background: rgba(0, 255, 65, 0.15); 
      border-color: rgba(0, 255, 65, 0.3);
      color: #00FF41; 
    }
    
    /* Cards */
    .card {
      background: #12121a;
      border: 1px solid #333;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #00FF41;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: #12121a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      font-family: 'IBM Plex Mono', monospace;
    }
    
    .stat-label {
      font-size: 12px;
      color: #7d8590;
      margin-top: 4px;
    }
    
    .orange { color: #00FF41; }
    .green { color: #22c55e; }
    .red { color: #ef4444; }
    .blue { color: #34aadc; }
    .gold { color: #ffd700; }
    
    /* Forms */
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    
    label {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      font-weight: 500;
    }
    
    input, select {
      background: #0a0a0f;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 14px;
      color: #fff;
      font-size: 14px;
      font-family: 'IBM Plex Sans', sans-serif;
      width: 100%;
      transition: all 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #00FF41;
      box-shadow: 0 0 0 3px rgba(0, 255, 65, 0.15);
    }
    
    input::placeholder { color: rgba(255,255,255,0.3); }
    select option { background: #1a2744; color: #fff; }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: 'IBM Plex Sans', sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #00FF41;
      color: #0a0a0f;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
    }
    
    .btn-secondary {
      background: transparent;
      color: #fff;
      border: 1px solid #333;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.05); }
    
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
      padding: 8px 16px;
      font-size: 12px;
    }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.2); }
    
    .btn-success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .btn-success:hover { background: rgba(34, 197, 94, 0.2); }
    
    .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
    
    /* Tables */
    .table-container {
      overflow-x: auto;
      margin-top: 16px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    
    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #333;
    }
    
    th {
      font-size: 11px;
      font-weight: 600;
      color: #00FF41;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    tr:hover { background: rgba(0, 255, 65, 0.05); }
    
    .mono { font-family: 'IBM Plex Mono', monospace; }
    .text-right { text-align: right; }
    
    .source-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .source-market { background: rgba(34, 170, 220, 0.15); color: #34aadc; }
    .source-private { background: rgba(255, 215, 0, 0.15); color: #ffd700; }
    .source-free { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    
    .type-paid { background: rgba(255, 215, 0, 0.15); color: #ffd700; }
    .type-free { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .type-trial { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    
    .product-ea { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .product-signal { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    
    /* Login */
    .login-box {
      max-width: 400px;
      margin: 80px auto;
      text-align: center;
    }
    
    .login-box h2 {
      color: #f7931a;
      margin-bottom: 24px;
    }
    
    /* Status messages */
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .status.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }
    
    .status.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    /* Panels */
    .panel { display: none; }
    .panel.active { display: block; }
    
    /* Year selector */
    .year-selector {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .year-selector select {
      width: auto;
      min-width: 120px;
    }
    
    /* Checkbox */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 0;
    }
    
    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #f7931a;
    }
    
    /* Responsive */
    @media (max-width: 640px) {
      .tabs { flex-wrap: wrap; }
      .tab { flex: 1; text-align: center; padding: 10px 16px; }
      .form-row { grid-template-columns: 1fr; }
      .btn-group { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }
    
    /* Tasse section */
    .tax-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .tax-row:last-child { border-bottom: none; }
    .tax-label { color: rgba(255,255,255,0.7); }
    .tax-value { font-family: 'IBM Plex Mono', monospace; font-weight: 600; }
    
    .tax-total {
      background: rgba(0, 255, 65, 0.1);
      border: 1px solid rgba(0, 255, 65, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
      text-align: center;
    }
    .tax-total-label { font-size: 14px; color: rgba(255,255,255,0.6); }
    .tax-total-value { font-size: 32px; font-weight: 700; color: #00FF41; margin-top: 8px; }
    
    /* MT5 Analyzer Styles */
    .drop-zone {
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 48px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .drop-zone:hover, .drop-zone.active {
      border-color: #00FF41;
      background: rgba(0, 255, 65, 0.05);
    }
    .mt5-year-card {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .mt5-year-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .mt5-year-badge {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #00a8ff, #0066ff);
      padding: 10px 20px;
      border-radius: 10px;
    }
    .mt5-account-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .mt5-stat { text-align: center; }
    .mt5-stat .label { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; }
    .mt5-stat .value { font-size: 14px; font-weight: 600; margin-top: 4px; }
    .mt5-profit { color: #00FF41; }
    .mt5-loss { color: #ef4444; }
    .mt5-info-box {
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 12px;
      background: rgba(0, 168, 255, 0.1);
      border: 1px solid rgba(0, 168, 255, 0.3);
      color: #00a8ff;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Login Panel -->
    <div id="loginPanel" class="panel active">
      <div class="login-box">
        <div class="badge">ü§ñ SMART TRADING BOTS</div>
        <h2 style="color:#00FF41;margin-bottom:24px;">üîê Admin Login</h2>
        <div class="card">
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="password" placeholder="Enter admin password" onkeypress="if(event.key==='Enter')login()">
          </div>
          <button class="btn btn-primary" style="width:100%; margin-top:16px;" onclick="login()">Login</button>
          <div id="loginError" style="margin-top:16px; color:#ef4444;"></div>
        </div>
      </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainPanel" class="panel">
      
      <!-- Header -->
      <div class="header">
        <div class="badge">ü§ñ SMART TRADING BOTS</div>
        <h1>EA Business Dashboard</h1>
        <p class="subtitle">Vendite ‚Ä¢ Licenze ‚Ä¢ Tasse</p>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="vendite">üìä Vendite</div>
        <div class="tab" data-tab="licenze">üîë Licenze</div>
        <div class="tab" data-tab="codici">üéüÔ∏è Codici</div>
        <div class="tab" data-tab="tasse">üí∞ Tasse</div>
        <div class="tab" data-tab="trading">üìà Trading MT5</div>
        <div class="tab" data-tab="export">üì• Export</div>
        <div class="tab" data-tab="settings">‚öôÔ∏è Impostazioni</div>
        <button class="btn btn-secondary" style="margin-left:auto;" onclick="logout()">Logout</button>
      </div>
      
      <div id="statusMsg"></div>

      <!-- ==================== VENDITE TAB ==================== -->
      <div id="tab-vendite" class="panel active">
        
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number orange" id="statTotaleSales">0</div>
            <div class="stat-label">Vendite Totali</div>
          </div>
          <div class="stat-card">
            <div class="stat-number blue" id="statMarket">0</div>
            <div class="stat-label">MQL5 Market</div>
          </div>
          <div class="stat-card">
            <div class="stat-number gold" id="statPrivate">0</div>
            <div class="stat-label">Private</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" style="color:#a855f7;" id="statEA">0</div>
            <div class="stat-label">EA Sales</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" style="color:#ec4899;" id="statSignal">0</div>
            <div class="stat-label">Signal Subs</div>
          </div>
          <div class="stat-card">
            <div class="stat-number green" id="statTotaleEUR">‚Ç¨0</div>
            <div class="stat-label">Totale Netto EUR</div>
          </div>
        </div>
        
        <!-- Year Filter -->
        <div class="year-selector">
          <label>Anno:</label>
          <select id="salesYear" onchange="loadSales()">
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026" selected>2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
          <button class="btn btn-secondary" onclick="toggleSaleForm()">+ Aggiungi Vendita</button>
          <input type="file" id="importMQL5File" accept=".json" style="display:none;" onchange="importMQL5JSON(event)">
          <button class="btn btn-secondary" onclick="document.getElementById('importMQL5File').click()">üì• Importa JSON MQL5</button>
        </div>
        
        <!-- Add Sale Form -->
        <div id="saleForm" class="card" style="display:none;">
          <div class="card-title">‚ûï Nuova Vendita</div>
          <div class="form-row">
            <div class="form-group">
              <label>Data</label>
              <input type="date" id="saleDate" onchange="fetchExchangeRate()">
            </div>
            <div class="form-group">
              <label>Prodotto</label>
              <select id="saleProduct">
                <option value="XAU_AutoTrader">XAU AutoTrader (EA)</option>
                <option value="BTC_AutoTrader">BTC AutoTrader (EA)</option>
                <option value="XAU_Signal">XAU Signal</option>
                <option value="BTC_Signal">BTC Signal</option>
              </select>
            </div>
            <div class="form-group">
              <label>Fonte</label>
              <select id="saleSource" onchange="togglePrivateFields()">
                <option value="market">MQL5 Market</option>
                <option value="private">Vendita Privata</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Importo USD</label>
              <input type="number" id="saleAmountUSD" placeholder="30.00" step="0.01" oninput="updateSalePreview()">
            </div>
            <div class="form-group">
              <label>Cambio EUR/USD <button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;" onclick="fetchExchangeRate()">üîÑ</button></label>
              <input type="number" id="saleExchangeRate" placeholder="1.0850" step="0.0001" oninput="updateSalePreview()">
            </div>
            <div class="form-group">
              <label>Anteprima Netto EUR</label>
              <input type="text" id="salePreviewEUR" readonly style="background:rgba(34,197,94,0.1);color:#22c55e;">
            </div>
          </div>
          
          <!-- Private sale fields -->
          <div id="privateFields" style="display:none;">
            <div class="form-row">
              <div class="form-group">
                <label>Nome Cliente</label>
                <input type="text" id="saleClientName" placeholder="Mario Rossi">
              </div>
              <div class="form-group">
                <label>Account MT4/MT5</label>
                <input type="text" id="saleAccountNumber" placeholder="12345678">
              </div>
            </div>
            <div class="checkbox-row">
              <input type="checkbox" id="saleCreateLicense" checked>
              <label for="saleCreateLicense">Crea automaticamente licenza per questo account</label>
            </div>
          </div>
          
          <div class="form-group">
            <label>Note (opzionale)</label>
            <input type="text" id="saleNotes" placeholder="Es: Sconto 10%, cliente referral...">
          </div>
          
          <div class="btn-group" style="margin-top:16px;">
            <button class="btn btn-primary" onclick="saveSale()">üíæ Salva Vendita</button>
            <button class="btn btn-secondary" onclick="toggleSaleForm()">Annulla</button>
          </div>
        </div>
        
        <!-- Sales Table -->
        <div class="card">
          <div class="card-title">üìã Storico Vendite</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Prodotto</th>
                  <th>Fonte</th>
                  <th class="text-right">USD</th>
                  <th class="text-right">Cambio</th>
                  <th class="text-right">EUR Lordo</th>
                  <th class="text-right">EUR Netto</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="salesTable">
                <tr><td colspan="8" style="text-align:center;color:rgba(255,255,255,0.4);">Caricamento...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== LICENZE TAB ==================== -->
      <div id="tab-licenze" class="panel">
        
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number orange" id="statTotaleLicenses">0</div>
            <div class="stat-label">Licenze Totali</div>
          </div>
          <div class="stat-card">
            <div class="stat-number gold" id="statXAU">0</div>
            <div class="stat-label">XAU_AutoTrader</div>
          </div>
          <div class="stat-card">
            <div class="stat-number blue" id="statBTC">0</div>
            <div class="stat-label">BTC_AutoTrader</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" style="color:#ffd700;" id="statPaid">0</div>
            <div class="stat-label">üí∞ Paid</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" style="color:#22c55e;" id="statFreeLic">0</div>
            <div class="stat-label">üéÅ Free</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" style="color:#f59e0b;" id="statTrial">0</div>
            <div class="stat-label">‚è±Ô∏è Trial</div>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="toggleLicenseForm()" style="margin-bottom:16px;">+ Aggiungi Licenza</button>
        
        <!-- Add License Form -->
        <div id="licenseForm" class="card" style="display:none;">
          <div class="card-title">‚ûï Nuova Licenza</div>
          <div class="form-row">
            <div class="form-group">
              <label>Account MT4/MT5</label>
              <input type="text" id="licAccountNumber" placeholder="12345678">
            </div>
            <div class="form-group">
              <label>Nome Cliente</label>
              <input type="text" id="licClientName" placeholder="Mario Rossi">
            </div>
            <div class="form-group">
              <label>Prodotto EA</label>
              <select id="licProduct">
                <option value="XAU_AutoTrader">XAU AutoTrader (EA)</option>
                <option value="BTC_AutoTrader">BTC AutoTrader (EA)</option>
                <option value="XAU_Signal">XAU Signal</option>
                <option value="BTC_Signal">BTC Signal</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tipo Licenza</label>
              <select id="licType" onchange="toggleTrialDays()">
                <option value="paid">üí∞ Paid (Lifetime)</option>
                <option value="free">üéÅ Free (Lifetime)</option>
                <option value="trial">‚è±Ô∏è Trial</option>
              </select>
            </div>
            <div class="form-group" id="trialDaysGroup" style="display:none;">
              <label>Giorni Trial</label>
              <input type="number" id="licTrialDays" value="7" min="1" max="90">
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="saveLicense()">üíæ Salva Licenza</button>
            <button class="btn btn-secondary" onclick="toggleLicenseForm()">Annulla</button>
          </div>
        </div>
        
        <!-- Licenses Table -->
        <div class="card">
          <div class="card-title">üîë Licenze Attive</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Account</th>
                  <th>Cliente</th>
                  <th>Prodotto</th>
                  <th>Tipo</th>
                  <th>Scadenza</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="licensesTable">
                <tr><td colspan="6" style="text-align:center;color:rgba(255,255,255,0.4);">Caricamento...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== CODICI TAB ==================== -->
      <div id="tab-codici" class="panel">
        
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number orange" id="statTotaleCodes">0</div>
            <div class="stat-label">Codici Totali</div>
          </div>
          <div class="stat-card">
            <div class="stat-number green" id="statAvailableCodes">0</div>
            <div class="stat-label">‚úÖ Disponibili</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" style="color:#6b7280;" id="statUsedCodes">0</div>
            <div class="stat-label">Usati</div>
          </div>
        </div>
        
        <button class="btn btn-secondary" onclick="toggleCodeForm()" style="margin-bottom:20px;">+ Crea Codice Attivazione</button>
        
        <!-- Create Code Form -->
        <div id="codeForm" class="card" style="display:none;">
          <div class="card-title">üéüÔ∏è Nuovo Codice Attivazione</div>
          <div class="form-row">
            <div class="form-group">
              <label>Prodotto</label>
              <select id="codeProduct">
                <option value="XAU_AutoTrader">XAU AutoTrader</option>
                <option value="BTC_AutoTrader">BTC AutoTrader</option>
              </select>
            </div>
            <div class="form-group">
              <label>Piattaforma</label>
              <select id="codePlatform">
                <option value="MT5">MT5</option>
                <option value="MT4">MT4</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tipo Licenza</label>
              <select id="codeType" onchange="toggleCodeTrialDays()">
                <option value="trial">‚è±Ô∏è Trial</option>
                <option value="free">üéÅ Free (Lifetime)</option>
                <option value="paid">üí∞ Paid (Lifetime)</option>
              </select>
            </div>
            <div class="form-group" id="codeTrialDaysGroup">
              <label>Giorni Trial</label>
              <input type="number" id="codeTrialDays" value="30" min="1" max="365">
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="createCode()">üéüÔ∏è Genera Codice</button>
            <button class="btn btn-secondary" onclick="toggleCodeForm()">Annulla</button>
          </div>
        </div>
        
        <!-- Codes Table -->
        <div class="card">
          <div class="card-title">üéüÔ∏è Codici Attivazione</div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Codice</th>
                  <th>Prodotto</th>
                  <th>Platform</th>
                  <th>Tipo</th>
                  <th>Giorni</th>
                  <th>Stato</th>
                  <th>Link</th>
                  <th>Azioni</th>
                </tr>
              </thead>
              <tbody id="codesTable">
                <tr><td colspan="8" style="text-align:center;color:rgba(255,255,255,0.4);">Caricamento...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ==================== TASSE TAB ==================== -->
      <div id="tab-tasse" class="panel">
        
        <div class="year-selector">
          <label>Anno fiscale:</label>
          <select id="taxYear" onchange="loadTaxData()">
            <option value="2021">2021</option>
            <option value="2022">2022</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026" selected>2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number green" id="taxLordoEUR">‚Ç¨0</div>
            <div class="stat-label">Lordo EUR (da dichiarare)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number orange" id="taxNettoEUR">‚Ç¨0</div>
            <div class="stat-label">Netto EUR (incassato)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number red" id="taxTotale">‚Ç¨0</div>
            <div class="stat-label">Imposte Stimate</div>
          </div>
        </div>
        
        <!-- Altri redditi -->
        <div class="card">
          <div class="card-title">üìù Dati Aggiuntivi (per calcolo imposte)</div>
          <div class="form-row">
            <div class="form-group">
              <label>Altri redditi annuali (stipendio, affitti, ecc.)</label>
              <input type="number" id="altriRedditi" placeholder="0" step="100" oninput="calculateTaxes()">
            </div>
            <div class="form-group">
              <label>Numero prelievi effettuati</label>
              <input type="number" id="numeroPrelievi" placeholder="0" step="1" min="0" oninput="calculateTaxes()">
            </div>
          </div>
          <p style="font-size:12px;color:rgba(255,255,255,0.5);margin-top:8px;">
            üí° Commissione MQL5: <strong>1.5%</strong> sul netto + <strong>1‚Ç¨</strong> per ogni prelievo
          </p>
        </div>
        
        <!-- Tax breakdown -->
        <div class="card">
          <div class="card-title">üí∞ Calcolo Imposte</div>
          <div id="taxBreakdown">
            <!-- Filled by JS -->
          </div>
        </div>
        
        <!-- Info box -->
        <div class="card" style="background:rgba(52,170,220,0.05);border-color:rgba(52,170,220,0.2);">
          <div class="card-title" style="color:#34aadc;">‚ÑπÔ∏è Info Dichiarazione</div>
          <ul style="font-size:13px;color:rgba(255,255,255,0.7);margin-left:20px;line-height:1.8;">
            <li><strong>Modello:</strong> Redditi PF oppure 730</li>
            <li><strong>Quadro:</strong> RL - Sezione II-A "Altri redditi"</li>
            <li><strong>Rigo:</strong> RL15 o RL16</li>
            <li><strong>Importo:</strong> Reddito LORDO (prima della commissione MQL5)</li>
            <li><strong>Costi deducibili:</strong> Commissione MQL5 20%</li>
            <li><strong>INPS:</strong> Obbligatoria solo se reddito > ‚Ç¨5.000</li>
          </ul>
        </div>
        
        <!-- Pulsante Report -->
        <button class="btn btn-primary" onclick="generaReportFiscale()" style="margin-top:20px;width:100%;">
          üìÑ Genera Report Fiscale per Commercialista
        </button>
      </div>

      <!-- ==================== TRADING MT5 TAB ==================== -->
      <div id="tab-trading" class="panel">
        
        <div class="card">
          <div class="card-title">üìà MT5 Fiscal Analyzer</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:20px;">
            Analizza i report MT5 per calcolare Quadro RT (plusvalenze) e RW (monitoraggio conti esteri)
          </p>
          
          <!-- Drop Zone -->
          <div id="mt5DropZone" class="drop-zone" onclick="document.getElementById('mt5FileInput').click()">
            <div style="font-size:48px;margin-bottom:16px;">üìä</div>
            <p>Trascina qui i report MT5 (.xlsx)</p>
            <p style="color:rgba(255,255,255,0.4);font-size:12px;margin-top:8px;">
              üí° Genera il report da MT5: Toolbox ‚Üí Cronologia ‚Üí Tasto destro ‚Üí Report ‚Üí Excel
            </p>
          </div>
          <input type="file" id="mt5FileInput" accept=".xlsx,.xls" multiple style="display:none;" onchange="handleMT5Files(event)">
        </div>
        
        <!-- Impostazioni Valuta -->
        <div id="mt5CurrencySettings" class="card" style="display:none;">
          <div class="card-title">üí± Impostazioni Valuta</div>
          <div class="form-row">
            <div class="form-group">
              <label>Cambio medio EUR/USD per anno</label>
              <p style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:10px;">
                Per conti in USD, i valori vengono convertiti in EUR usando questi cambi
              </p>
            </div>
          </div>
          <div class="form-row" id="mt5ExchangeRates">
            <!-- Popolato dinamicamente -->
          </div>
          <div style="margin-top:10px;">
            <button class="btn btn-secondary" onclick="resetMT5ExchangeRates()">üîÑ Ripristina Default</button>
          </div>
        </div>
        
        <!-- Risultati -->
        <div id="mt5Results" style="display:none;">
          
          <!-- Riepilogo Totale -->
          <div class="card" style="background:linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,168,255,0.1));">
            <div class="card-title">üìä Riepilogo Totale</div>
            <div class="stats-grid" id="mt5TotalStats">
              <!-- Popolato dinamicamente -->
            </div>
          </div>
          
          <!-- Dettaglio per Anno -->
          <div id="mt5YearlyResults">
            <!-- Popolato dinamicamente -->
          </div>
          
          <!-- Azioni -->
          <div class="card">
            <div class="card-title">üìë Genera Documenti</div>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="exportAllMT5PDF()">üìÑ Genera Tutti i PDF (RT + RW)</button>
              <button class="btn btn-secondary" onclick="exportMT5CSV()">üì• Export CSV</button>
              <button class="btn btn-danger" onclick="clearMT5Data()">üóëÔ∏è Cancella Dati</button>
            </div>
          </div>
        </div>
        
      </div>

      <!-- ==================== EXPORT TAB ==================== -->
      <div id="tab-export" class="panel">
        
        <div class="card">
          <div class="card-title">üì• Export Dati</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:20px;">
            Scarica un backup completo di tutti i dati (vendite + licenze) in formato JSON.
          </p>
          
          <div class="year-selector">
            <label>Anno vendite:</label>
            <select id="exportYear">
              <option value="">Tutti gli anni</option>
              <option value="2021">2021</option>
              <option value="2022">2022</option>
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026" selected>2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
              <option value="2029">2029</option>
              <option value="2030">2030</option>
            </select>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="exportJSON()">üì• Scarica JSON</button>
            <button class="btn btn-success" onclick="generateTaxReport()">üìÑ Report Fiscale PDF</button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-title">üì§ Importa Dati</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:20px;">
            Carica un file JSON esportato in precedenza per ripristinare i dati.
          </p>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importJSON(event)">
          <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üìÇ Carica JSON</button>
        </div>
        
        <div class="card" style="background:rgba(239,68,68,0.05);border-color:rgba(239,68,68,0.2);">
          <div class="card-title" style="color:#ef4444;">‚ö†Ô∏è Zona Pericolosa</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:16px;">
            Esporta sempre un backup prima di effettuare operazioni distruttive.
          </p>
          <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Cancella tutti i dati</button>
        </div>
      </div>

      <!-- ==================== SETTINGS TAB ==================== -->
      <div id="tab-settings" class="panel">
        
        <div class="card">
          <div class="card-title">üí∞ Prezzi Vendita Privata</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:20px;">
            Imposta i prezzi per la pagina di acquisto privata. I clienti vedranno questi prezzi.
          </p>
          <div class="form-row">
            <div class="form-group">
              <label>XAU AutoTrader (EUR)</label>
              <input type="number" id="priceXAU" value="499" step="1">
            </div>
            <div class="form-group">
              <label>BTC AutoTrader (EUR)</label>
              <input type="number" id="priceBTC" value="499" step="1">
            </div>
          </div>
          <button class="btn btn-primary" onclick="saveSettings()">üíæ Salva Prezzi</button>
        </div>
        
        <div class="card">
          <div class="card-title">üîó Link Pagina Acquisto</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:16px;">
            Condividi questo link con i clienti per acquisti privati:
          </p>
          <div style="display:flex;gap:12px;align-items:center;">
            <input type="text" id="buyLink" readonly value="" style="flex:1;background:#0a0a0f;">
            <button class="btn btn-secondary" onclick="copyBuyLink()">üìã Copia</button>
          </div>
        </div>
        
        <div class="card">
          <div class="card-title">üîë Stripe API Keys</div>
          <p style="color:rgba(255,255,255,0.6);margin-bottom:16px;">
            Le chiavi Stripe sono configurate nelle Environment Variables di Vercel.<br>
            <a href="https://vercel.com" target="_blank" style="color:#00FF41;">Vai su Vercel</a> ‚Üí Settings ‚Üí Environment Variables
          </p>
          <ul style="color:rgba(255,255,255,0.5);font-size:13px;margin-left:20px;">
            <li><code>STRIPE_SECRET_KEY</code> - sk_live_...</li>
            <li><code>STRIPE_PUBLISHABLE_KEY</code> - pk_live_...</li>
            <li><code>STRIPE_WEBHOOK_SECRET</code> - whsec_...</li>
          </ul>
        </div>
        
      </div>
      
    </div>
  </div>

  <script>
    // ==================== GLOBALS ====================
    let adminPassword = '';
    let sales = [];
    let licenses = [];
    let altriRedditiValue = 0;
    
    const $ = id => document.getElementById(id);
    
    // ==================== AUTH ====================
    async function login() {
      adminPassword = $('password').value;
      if (!adminPassword) {
        $('loginError').textContent = 'Inserisci la password';
        return;
      }
      
      try {
        const res = await fetch('/api/admin?type=licenses', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        if (!res.ok) {
          $('loginError').textContent = 'Password errata';
          return;
        }
        
        localStorage.setItem('eaDashPwd', adminPassword);
        $('loginPanel').classList.remove('active');
        $('mainPanel').classList.add('active');
        
        loadSales();
        loadLicenses();
        
      } catch (err) {
        $('loginError').textContent = 'Errore di connessione';
      }
    }
    
    function logout() {
      adminPassword = '';
      localStorage.removeItem('eaDashPwd');
      $('mainPanel').classList.remove('active');
      $('loginPanel').classList.add('active');
      $('password').value = '';
    }
    
    // ==================== TABS ====================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => {
          if (p.id.startsWith('tab-')) p.classList.remove('active');
        });
        
        tab.classList.add('active');
        const tabId = 'tab-' + tab.dataset.tab;
        $(tabId).classList.add('active');
        
        // Refresh dati quando cambi tab
        if (tab.dataset.tab === 'vendite') loadSales();
        if (tab.dataset.tab === 'licenze') loadLicenses();
        if (tab.dataset.tab === 'codici') loadCodes();
        if (tab.dataset.tab === 'tasse') loadTaxData();
        if (tab.dataset.tab === 'settings') loadSettings();
      });
    });
    
    // ==================== STATUS ====================
    function showStatus(msg, isError = false) {
      const el = $('statusMsg');
      el.innerHTML = `<div class="status ${isError ? 'error' : 'success'}">${msg}</div>`;
      setTimeout(() => el.innerHTML = '', 4000);
    }
    
    // ==================== SALES ====================
    async function loadSales() {
      const year = $('salesYear').value;
      
      try {
        const res = await fetch(`/api/admin?type=sales&year=${year}`, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        sales = data.sales || [];
        renderSales();
        
      } catch (err) {
        showStatus('Errore caricamento vendite', true);
      }
    }
    
    function renderSales() {
      const tbody = $('salesTable');
      
      if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:rgba(255,255,255,0.4);">Nessuna vendita per questo anno</td></tr>';
        updateSalesStats();
        return;
      }
      
      tbody.innerHTML = sales.map(s => {
        const isSignal = s.ea_product.includes('Signal');
        const productLabel = s.ea_product.replace('_', ' ');
        const productClass = isSignal ? 'product-signal' : 'product-ea';
        return `
        <tr>
          <td>${formatDate(s.sale_date)}</td>
          <td><span class="source-badge ${productClass}">${productLabel}</span></td>
          <td><span class="source-badge source-${s.source}">${s.source === 'market' ? 'Market' : 'Private'}</span></td>
          <td class="text-right mono">$${s.amount_usd.toFixed(2)}</td>
          <td class="text-right mono">${s.exchange_rate.toFixed(4)}</td>
          <td class="text-right mono">‚Ç¨${s.amount_eur_gross.toFixed(2)}</td>
          <td class="text-right mono green">‚Ç¨${s.amount_eur_net.toFixed(2)}</td>
          <td><button class="btn btn-danger" onclick="deleteSale(${s.id})">üóëÔ∏è</button></td>
        </tr>
      `}).join('');
      
      updateSalesStats();
    }
    
    function updateSalesStats() {
      const market = sales.filter(s => s.source === 'market');
      const priv = sales.filter(s => s.source === 'private');
      const eaSales = sales.filter(s => s.ea_product.includes('AutoTrader'));
      const signalSales = sales.filter(s => s.ea_product.includes('Signal'));
      const totalNet = sales.reduce((sum, s) => sum + s.amount_eur_net, 0);
      
      $('statTotaleSales').textContent = sales.length;
      $('statMarket').textContent = market.length;
      $('statPrivate').textContent = priv.length;
      $('statEA').textContent = eaSales.length;
      $('statSignal').textContent = signalSales.length;
      $('statTotaleEUR').textContent = '‚Ç¨' + totalNet.toFixed(0);
    }
    
    function toggleSaleForm() {
      const form = $('saleForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      
      if (form.style.display === 'block') {
        $('saleDate').value = new Date().toISOString().split('T')[0];
        fetchExchangeRate();
      }
    }
    
    function togglePrivateFields() {
      const isPrivate = $('saleSource').value === 'private';
      $('privateFields').style.display = isPrivate ? 'block' : 'none';
    }
    
    function updateSalePreview() {
      const usd = parseFloat($('saleAmountUSD').value) || 0;
      const rate = parseFloat($('saleExchangeRate').value) || 1;
      const netEUR = (usd / rate) * 0.80;
      $('salePreviewEUR').value = '‚Ç¨' + netEUR.toFixed(2);
    }
    
    async function fetchExchangeRate() {
      const dateField = $('saleDate');
      const rateField = $('saleExchangeRate');
      
      if (!dateField.value) return;
      
      rateField.value = '...';
      
      try {
        const date = dateField.value;
        const res = await fetch(`https://api.frankfurter.app/${date}?from=USD&to=EUR`);
        const data = await res.json();
        const rate = 1 / data.rates.EUR;
        rateField.value = rate.toFixed(4);
        updateSalePreview();
      } catch {
        rateField.value = '1.0850';
        updateSalePreview();
      }
    }
    
    async function saveSale() {
      const source = $('saleSource').value;
      
      const saleData = {
        sale_date: $('saleDate').value,
        ea_product: $('saleProduct').value,
        source: source,
        amount_usd: $('saleAmountUSD').value,
        exchange_rate: $('saleExchangeRate').value,
        notes: $('saleNotes').value
      };
      
      if (source === 'private') {
        saleData.client_name = $('saleClientName').value;
        saleData.account_number = $('saleAccountNumber').value;
        saleData.create_license = $('saleCreateLicense').checked;
      }
      
      if (!saleData.sale_date || !saleData.amount_usd || !saleData.exchange_rate) {
        showStatus('Compila tutti i campi obbligatori', true);
        return;
      }
      
      try {
        const res = await fetch('/api/admin?type=sales', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify(saleData)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          showStatus(data.error || 'Errore', true);
          return;
        }
        
        let msg = '‚úÖ Vendita salvata!';
        if (data.licenseCreated) msg += ' + Licenza creata automaticamente!';
        
        showStatus(msg);
        toggleSaleForm();
        loadSales();
        if (data.licenseCreated) loadLicenses();
        
        // Reset form
        $('saleAmountUSD').value = '';
        $('saleNotes').value = '';
        $('saleClientName').value = '';
        $('saleAccountNumber').value = '';
        
      } catch (err) {
        showStatus('Errore di rete', true);
      }
    }
    
    async function deleteSale(id) {
      if (!confirm('Eliminare questa vendita?')) return;
      
      try {
        const res = await fetch('/api/admin?type=sales', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ id })
        });
        
        if (!res.ok) {
          showStatus('Errore eliminazione', true);
          return;
        }
        
        showStatus('‚úÖ Vendita eliminata');
        loadSales();
        
      } catch (err) {
        showStatus('Errore di rete', true);
      }
    }
    
    // ==================== LICENSES ====================
    async function loadLicenses() {
      try {
        const res = await fetch('/api/admin?type=licenses', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        if (!res.ok) throw new Error('Failed');
        
        const data = await res.json();
        licenses = data.licenses || [];
        renderLicenses();
        
      } catch (err) {
        showStatus('Errore caricamento licenze', true);
      }
    }
    
    function renderLicenses() {
      const tbody = $('licensesTable');
      
      if (licenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:rgba(255,255,255,0.4);">Nessuna licenza attiva</td></tr>';
        updateLicenseStats();
        return;
      }
      
      tbody.innerHTML = licenses.map(l => {
        const licType = l.license_type || 'paid';
        let typeLabel, typeClass;
        
        if (licType === 'trial') {
          typeLabel = '‚è±Ô∏è Trial';
          typeClass = 'type-trial';
        } else if (licType === 'free') {
          typeLabel = 'üéÅ Free';
          typeClass = 'type-free';
        } else {
          typeLabel = 'üí∞ Paid';
          typeClass = 'type-paid';
        }
        
        // Calcola scadenza
        let expiresLabel = 'Lifetime';
        if (licType === 'trial' && l.expires_at) {
          const expires = new Date(l.expires_at);
          const now = new Date();
          const daysLeft = Math.ceil((expires - now) / (1000 * 60 * 60 * 24));
          
          if (daysLeft < 0) {
            expiresLabel = '<span style="color:#ef4444;">‚õî Scaduta</span>';
          } else if (daysLeft === 0) {
            expiresLabel = '<span style="color:#f59e0b;">‚ö†Ô∏è Scade oggi</span>';
          } else if (daysLeft <= 3) {
            expiresLabel = `<span style="color:#f59e0b;">${daysLeft}g rimasti</span>`;
          } else {
            expiresLabel = `${daysLeft}g (${formatDate(l.expires_at)})`;
          }
        }
        
        return `
        <tr>
          <td class="mono">${l.account_number}</td>
          <td>${l.client_name}</td>
          <td>${l.ea_product.replace('_', ' ')}</td>
          <td><span class="source-badge ${typeClass}">${typeLabel}</span></td>
          <td>${expiresLabel}</td>
          <td><button class="btn btn-danger" onclick="deleteLicense(${l.id})">üóëÔ∏è</button></td>
        </tr>
      `}).join('');
      
      updateLicenseStats();
    }
    
    function updateLicenseStats() {
      const xau = licenses.filter(l => l.ea_product === 'XAU_AutoTrader');
      const btc = licenses.filter(l => l.ea_product === 'BTC_AutoTrader');
      const paid = licenses.filter(l => (l.license_type || 'paid') === 'paid');
      const free = licenses.filter(l => l.license_type === 'free');
      const trial = licenses.filter(l => l.license_type === 'trial');
      
      $('statTotaleLicenses').textContent = licenses.length;
      $('statXAU').textContent = xau.length;
      $('statBTC').textContent = btc.length;
      $('statPaid').textContent = paid.length;
      $('statFreeLic').textContent = free.length;
      $('statTrial').textContent = trial.length;
    }
    
    function toggleLicenseForm() {
      const form = $('licenseForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block') {
        $('licAccountNumber').value = '';
        $('licClientName').value = '';
        $('licType').value = 'paid';
        $('licTrialDays').value = '7';
        toggleTrialDays();
      }
    }
    
    function toggleTrialDays() {
      const isTrial = $('licType').value === 'trial';
      $('trialDaysGroup').style.display = isTrial ? 'block' : 'none';
    }
    
    async function saveLicense() {
      const licenseType = $('licType').value;
      const licenseData = {
        account_number: $('licAccountNumber').value.trim(),
        client_name: $('licClientName').value.trim(),
        ea_product: $('licProduct').value,
        license_type: licenseType
      };
      
      if (licenseType === 'trial') {
        licenseData.trial_days = parseInt($('licTrialDays').value) || 7;
      }
      
      if (!licenseData.account_number || !licenseData.client_name) {
        showStatus('Compila tutti i campi', true);
        return;
      }
      
      try {
        const res = await fetch('/api/admin?type=licenses', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify(licenseData)
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          showStatus(data.error || 'Errore', true);
          return;
        }
        
        showStatus('‚úÖ Licenza creata!');
        toggleLicenseForm();
        loadLicenses();
        
        $('licAccountNumber').value = '';
        $('licClientName').value = '';
        
      } catch (err) {
        showStatus('Errore di rete', true);
      }
    }
    
    async function deleteLicense(id) {
      if (!confirm('Eliminare questa licenza?')) return;
      
      try {
        const res = await fetch('/api/admin?type=licenses', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ id })
        });
        
        if (!res.ok) {
          showStatus('Errore eliminazione', true);
          return;
        }
        
        showStatus('‚úÖ Licenza eliminata');
        loadLicenses();
        
      } catch (err) {
        showStatus('Errore di rete', true);
      }
    }
    
    // ==================== TAXES ====================
    async function loadTaxData() {
      const year = $('taxYear').value;
      
      try {
        const res = await fetch(`/api/admin?type=sales&year=${year}`, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        if (!res.ok) throw new Error('Failed');
        
        const data = await res.json();
        sales = data.sales || [];
        calculateTaxes();
        
      } catch (err) {
        showStatus('Errore caricamento dati fiscali', true);
      }
    }
    
    function calculateTaxes() {
      const totLordoEUR = sales.reduce((sum, s) => sum + s.amount_eur_gross, 0);
      const totNettoEUR = sales.reduce((sum, s) => sum + s.amount_eur_net, 0);
      const commissioneMQL5 = totLordoEUR - totNettoEUR;
      
      altriRedditiValue = parseFloat($('altriRedditi').value) || 0;
      const numeroPrelievi = parseInt($('numeroPrelievi').value) || 0;
      
      // Commissioni prelievo: 1.5% sul netto + 1‚Ç¨ per ogni prelievo
      const commissioniPrelievo = (totNettoEUR * 0.015) + (numeroPrelievi * 1);
      
      // Reddito imponibile = Netto - commissioni prelievo
      const redditoImponibileMQL5 = totNettoEUR - commissioniPrelievo;
      const redditoTotale = redditoImponibileMQL5 + altriRedditiValue;
      
      // IRPEF progressiva italiana
      let irpefTotale = 0;
      let remaining = redditoTotale;
      
      if (remaining > 0) {
        const first = Math.min(remaining, 28000);
        irpefTotale += first * 0.23;
        remaining -= first;
      }
      if (remaining > 0) {
        const second = Math.min(remaining, 22000); // 28k-50k
        irpefTotale += second * 0.35;
        remaining -= second;
      }
      if (remaining > 0) {
        irpefTotale += remaining * 0.43;
      }
      
      // Proporzione IRPEF su MQL5
      const proporzione = redditoTotale > 0 ? redditoImponibileMQL5 / redditoTotale : 0;
      const irpefMQL5 = irpefTotale * proporzione;
      
      // INPS (solo se > 5000‚Ç¨)
      const sogliaINPS = 5000;
      const aliquotaINPS = 0.2607;
      let inps = 0;
      if (redditoImponibileMQL5 > sogliaINPS) {
        inps = redditoImponibileMQL5 * aliquotaINPS;
      }
      
      // Addizionali (stima 2%)
      const addizionali = irpefMQL5 * 0.087;
      
      const totaleImposte = irpefMQL5 + inps + addizionali;
      
      // Update UI
      $('taxLordoEUR').textContent = '‚Ç¨' + totLordoEUR.toFixed(0);
      $('taxNettoEUR').textContent = '‚Ç¨' + totNettoEUR.toFixed(0);
      $('taxTotale').textContent = '‚Ç¨' + totaleImposte.toFixed(0);
      
      const inpsNote = redditoImponibileMQL5 > sogliaINPS 
        ? `<span style="color:#ef4444;">‚ö†Ô∏è Superata soglia ‚Ç¨5.000</span>`
        : `<span style="color:#22c55e;">Sotto soglia ‚Ç¨5.000</span>`;
      
      $('taxBreakdown').innerHTML = `
        <div class="tax-row">
          <span class="tax-label">Reddito lordo MQL5</span>
          <span class="tax-value">‚Ç¨${totLordoEUR.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">Commissione MQL5 deducibile (20%)</span>
          <span class="tax-value green">- ‚Ç¨${commissioneMQL5.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">Commissioni prelievo (1.5% + ${numeroPrelievi}√ó1‚Ç¨)</span>
          <span class="tax-value green">- ‚Ç¨${commissioniPrelievo.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">Reddito imponibile MQL5</span>
          <span class="tax-value">‚Ç¨${redditoImponibileMQL5.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">Altri redditi</span>
          <span class="tax-value">‚Ç¨${altriRedditiValue.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">Reddito complessivo</span>
          <span class="tax-value">‚Ç¨${redditoTotale.toFixed(2)}</span>
        </div>
        <hr style="border-color:rgba(255,255,255,0.1);margin:12px 0;">
        <div class="tax-row">
          <span class="tax-label">IRPEF su MQL5 (aliquota marginale)</span>
          <span class="tax-value red">‚Ç¨${irpefMQL5.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">INPS Gestione Separata (26.07%) ${inpsNote}</span>
          <span class="tax-value red">‚Ç¨${inps.toFixed(2)}</span>
        </div>
        <div class="tax-row">
          <span class="tax-label">Addizionali regionali/comunali (stima)</span>
          <span class="tax-value red">‚Ç¨${addizionali.toFixed(2)}</span>
        </div>
        <div class="tax-total">
          <div class="tax-total-label">TOTALE IMPOSTE STIMATE</div>
          <div class="tax-total-value">‚Ç¨${totaleImposte.toFixed(2)}</div>
        </div>
      `;
    }
    
    // ==================== REPORT FISCALE ====================
    function generaReportFiscale() {
      const year = $('taxYear').value;
      const totLordoEUR = sales.reduce((sum, s) => sum + s.amount_eur_gross, 0);
      const totNettoEUR = sales.reduce((sum, s) => sum + s.amount_eur_net, 0);
      const commissioneMQL5 = totLordoEUR - totNettoEUR;
      const altriRedditiVal = parseFloat($('altriRedditi').value) || 0;
      const numeroPrelievi = parseInt($('numeroPrelievi').value) || 0;
      
      // Commissioni prelievo: 1.5% sul netto + 1‚Ç¨ per ogni prelievo
      const commissioniPrelievoVal = (totNettoEUR * 0.015) + (numeroPrelievi * 1);
      
      const redditoImponibileMQL5 = totNettoEUR - commissioniPrelievoVal;
      const redditoTotale = redditoImponibileMQL5 + altriRedditiVal;
      
      // IRPEF progressiva
      let irpefTotale = 0;
      let remaining = redditoTotale;
      if (remaining > 0) { const first = Math.min(remaining, 28000); irpefTotale += first * 0.23; remaining -= first; }
      if (remaining > 0) { const second = Math.min(remaining, 22000); irpefTotale += second * 0.35; remaining -= second; }
      if (remaining > 0) { irpefTotale += remaining * 0.43; }
      
      const proporzione = redditoTotale > 0 ? redditoImponibileMQL5 / redditoTotale : 0;
      const irpefMQL5 = irpefTotale * proporzione;
      
      const sogliaINPS = 5000;
      const inps = redditoImponibileMQL5 > sogliaINPS ? redditoImponibileMQL5 * 0.2607 : 0;
      const addizionali = irpefMQL5 * 0.087;
      const totaleImposte = irpefMQL5 + inps + addizionali;
      
      // Dettaglio vendite
      let venditeRows = '';
      const salesSorted = [...sales].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      salesSorted.forEach(s => {
        const data = new Date(s.created_at).toLocaleDateString('it-IT');
        venditeRows += `<tr>
          <td>${data}</td>
          <td>${s.ea_product || 'EA'}</td>
          <td class="number">$${s.amount_usd.toFixed(2)}</td>
          <td class="number">${s.exchange_rate ? s.exchange_rate.toFixed(4) : '-'}</td>
          <td class="number">‚Ç¨${s.amount_eur_gross.toFixed(2)}</td>
          <td class="number">‚Ç¨${s.amount_eur_net.toFixed(2)}</td>
        </tr>`;
      });
      
      const inpsRow = inps > 0 
        ? `<div class="row"><span class="label">INPS Gestione Separata (26.07%)</span><span class="value">‚Ç¨${inps.toFixed(2)}</span></div>` 
        : `<div class="row"><span class="label">INPS Gestione Separata</span><span class="value" style="color: #4caf50;">‚Ç¨0,00 (sotto soglia 5.000‚Ç¨)</span></div>`;
      
      const inpsNote = redditoImponibileMQL5 > sogliaINPS 
        ? `<li style="color: #d32f2f;"><strong>‚ö†Ô∏è INPS:</strong> Superata soglia 5.000‚Ç¨ - Obbligo iscrizione Gestione Separata</li>` 
        : `<li><strong>INPS:</strong> Non dovuta (reddito sotto 5.000‚Ç¨)</li>`;
      
      const today = new Date().toLocaleDateString('it-IT');
      
      const reportHTML = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8"><title>Report Fiscale MQL5 - Anno ${year}</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script>
        <style>
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: Segoe UI, Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #1a1a1a; line-height: 1.6; }
          .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #f7931a; }
          .header h1 { font-size: 28px; color: #1a1a1a; margin-bottom: 8px; }
          .header .subtitle { color: #666; font-size: 14px; }
          .section { margin-bottom: 32px; background: #f9f9f9; border-radius: 8px; padding: 24px; }
          .section h2 { font-size: 16px; color: #f7931a; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #ddd; }
          .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
          .row:last-child { border-bottom: none; }
          .row .label { color: #555; }
          .row .value { font-weight: 600; font-family: Consolas, monospace; }
          .highlight { background: #fff3e0; border: 2px solid #f7931a; padding: 20px; border-radius: 8px; margin: 24px 0; }
          .highlight .label { font-size: 14px; color: #666; }
          .highlight .value { font-size: 32px; color: #f7931a; font-weight: 700; }
          table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
          th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #ddd; }
          th { background: #f0f0f0; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
          td.number { text-align: right; font-family: Consolas, monospace; }
          .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 16px; margin-top: 24px; font-size: 13px; }
          .info-box h4 { color: #1976d2; margin-bottom: 8px; }
          .info-box ul { margin-left: 20px; }
          .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #888; }
          .quadro-box { background: #fff; border: 2px solid #4caf50; border-radius: 8px; padding: 20px; margin: 16px 0; }
          .quadro-box h3 { color: #4caf50; margin-bottom: 12px; font-size: 18px; }
          .btn-pdf { display: block; margin: 20px auto; padding: 14px 32px; background: linear-gradient(135deg, #f7931a 0%, #e8850a 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
          .btn-pdf:hover { opacity: 0.9; }
          @media print { body { padding: 20px; } .section { break-inside: avoid; } .btn-pdf { display: none; } }
        </style></head><body>
        <button class="btn-pdf" onclick="scaricaPDF()">üì• Scarica PDF</button>
        <div id="report-content">
          <div class="header">
            <h1>üìä Report Fiscale MQL5</h1>
            <div class="subtitle">Anno d'imposta ${year} ‚Ä¢ Generato il ${today}</div>
          </div>
          
          <div class="section">
            <h2>üìã Riepilogo Vendite</h2>
            <div class="row"><span class="label">Numero vendite</span><span class="value">${sales.length}</span></div>
            <div class="row"><span class="label">Totale lordo EUR</span><span class="value">‚Ç¨${totLordoEUR.toFixed(2)}</span></div>
            <div class="row"><span class="label">Commissione piattaforma (20%)</span><span class="value">- ‚Ç¨${commissioneMQL5.toFixed(2)}</span></div>
            <div class="row"><span class="label">Commissioni prelievo (1.5% + ${numeroPrelievi}√ó1‚Ç¨)</span><span class="value">- ‚Ç¨${commissioniPrelievoVal.toFixed(2)}</span></div>
            <div class="row"><span class="label">Totale netto EUR (incassato)</span><span class="value" style="color: #4caf50;">‚Ç¨${(totNettoEUR - commissioniPrelievoVal).toFixed(2)}</span></div>
          </div>
          
          <div class="quadro-box">
            <h3>üìù Quadro RL - Redditi Diversi</h3>
            <p style="margin-bottom: 12px; color: #555;">Importo da dichiarare nel <strong>Quadro RL, Sezione II-A</strong> del Modello Redditi PF:</p>
            <div class="highlight" style="background: #e8f5e9; border-color: #4caf50;">
              <div class="label">REDDITO LORDO DA DICHIARARE</div>
              <div class="value" style="color: #2e7d32;">‚Ç¨${totLordoEUR.toFixed(2)}</div>
            </div>
            <p style="font-size: 13px; color: #666; margin-top: 12px;">‚ö†Ô∏è Si dichiara il <strong>lordo</strong> (prima della commissione). La commissione del 20% e le commissioni di prelievo sono deducibili come costi di produzione del reddito.</p>
          </div>
          
          <div class="section">
            <h2>üí∞ Calcolo Imposte Stimate</h2>
            <div class="row"><span class="label">Reddito lordo MQL5</span><span class="value">‚Ç¨${totLordoEUR.toFixed(2)}</span></div>
            <div class="row"><span class="label">Commissione piattaforma deducibile (20%)</span><span class="value" style="color: #4caf50;">- ‚Ç¨${commissioneMQL5.toFixed(2)}</span></div>
            <div class="row"><span class="label">Commissioni prelievo deducibili (1.5% + ${numeroPrelievi}√ó1‚Ç¨)</span><span class="value" style="color: #4caf50;">- ‚Ç¨${commissioniPrelievoVal.toFixed(2)}</span></div>
            <div class="row"><span class="label">Reddito imponibile MQL5</span><span class="value">‚Ç¨${redditoImponibileMQL5.toFixed(2)}</span></div>
            <div class="row"><span class="label">Altri redditi dichiarati</span><span class="value">‚Ç¨${altriRedditiVal.toFixed(2)}</span></div>
            <div class="row"><span class="label">Reddito complessivo</span><span class="value">‚Ç¨${redditoTotale.toFixed(2)}</span></div>
            <div class="row"><span class="label">IRPEF su reddito MQL5 (aliquota marginale)</span><span class="value">‚Ç¨${irpefMQL5.toFixed(2)}</span></div>
            ${inpsRow}
            <div class="row"><span class="label">Addizionali regionali/comunali (stima)</span><span class="value">‚Ç¨${addizionali.toFixed(2)}</span></div>
            <div class="highlight">
              <div class="label">TOTALE IMPOSTE STIMATE</div>
              <div class="value">‚Ç¨${totaleImposte.toFixed(2)}</div>
            </div>
          </div>
          
          <div class="section">
            <h2>üìë Dettaglio Vendite</h2>
            <table>
              <thead>
                <tr><th>Data</th><th>Prodotto</th><th>Lordo USD</th><th>Cambio</th><th>Lordo EUR</th><th>Netto EUR</th></tr>
              </thead>
              <tbody>
                ${venditeRows}
                <tr style="font-weight: bold; background: #f5f5f5;">
                  <td colspan="2">TOTALE</td>
                  <td class="number">$${sales.reduce((s,x) => s + x.amount_usd, 0).toFixed(2)}</td>
                  <td></td>
                  <td class="number">‚Ç¨${totLordoEUR.toFixed(2)}</td>
                  <td class="number">‚Ç¨${totNettoEUR.toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="info-box">
            <h4>‚ÑπÔ∏è Istruzioni per la Dichiarazione</h4>
            <ul>
              <li><strong>Modello:</strong> Redditi PF oppure 730 (se hai sostituto d'imposta)</li>
              <li><strong>Quadro:</strong> RL - Sezione II-A "Altri redditi di lavoro autonomo"</li>
              <li><strong>Rigo:</strong> RL15 o RL16</li>
              <li><strong>Importo:</strong> Reddito LORDO (‚Ç¨${totLordoEUR.toFixed(2)})</li>
              <li><strong>Costi deducibili:</strong> Commissione 20% (‚Ç¨${commissioneMQL5.toFixed(2)}) + Commissioni prelievo (‚Ç¨${commissioniPrelievoVal.toFixed(2)})</li>
              ${inpsNote}
            </ul>
          </div>
          
          <div class="footer">
            <p>Report generato automaticamente da EA Business Dashboard</p>
            <p>‚ö†Ô∏è Documento indicativo - Consultare un commercialista per la dichiarazione ufficiale</p>
          </div>
        </div>
        <script>
          function scaricaPDF() {
            var element = document.getElementById("report-content");
            var opt = {
              margin: 10,
              filename: "Report-Fiscale-MQL5-${year}.pdf",
              image: { type: "jpeg", quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
            };
            html2pdf().set(opt).from(element).save();
          }
        <\/script>
        </body></html>`;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(reportHTML);
      printWindow.document.close();
    }
    
    // ==================== EXPORT ====================
    async function exportJSON() {
      const year = $('exportYear').value;
      
      try {
        const url = year ? `/api/admin?type=export&year=${year}` : '/api/admin?type=export';
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        if (!res.ok) throw new Error('Failed');
        
        const data = await res.json();
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url2 = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url2;
        a.download = `EA-Dashboard-Backup-${year || 'ALL'}-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url2);
        
        showStatus('‚úÖ Export completato!');
        
      } catch (err) {
        showStatus('Errore export', true);
      }
    }
    
    async function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (!confirm('ATTENZIONE: Questo importer√† i dati dal file. Vuoi continuare?')) {
        event.target.value = '';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // TODO: Implement import logic via API
          showStatus('‚ö†Ô∏è Import non ancora implementato. Contatta lo sviluppatore.', true);
          
        } catch (err) {
          showStatus('File JSON non valido', true);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function generateTaxReport() {
      const year = $('taxYear').value;
      const totLordoEUR = sales.reduce((sum, s) => sum + s.amount_eur_gross, 0);
      const totNettoEUR = sales.reduce((sum, s) => sum + s.amount_eur_net, 0);
      
      // Open in new window with print-friendly HTML
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Report Fiscale MQL5 - ${year}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
            h1 { color: #f7931a; border-bottom: 3px solid #f7931a; padding-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background: #f5f5f5; }
            .total { font-weight: bold; font-size: 1.2em; color: #f7931a; }
            .info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; }
            @media print { body { padding: 20px; } }
          </style>
        </head>
        <body>
          <h1>üìä Report Fiscale MQL5 - Anno ${year}</h1>
          <p>Generato il ${formatDate(new Date().toISOString())}</p>
          
          <h2>Riepilogo</h2>
          <table>
            <tr><td>Numero vendite</td><td>${sales.length}</td></tr>
            <tr><td>Totale lordo EUR</td><td>‚Ç¨${totLordoEUR.toFixed(2)}</td></tr>
            <tr><td>Commissione MQL5 (20%)</td><td>- ‚Ç¨${(totLordoEUR - totNettoEUR).toFixed(2)}</td></tr>
            <tr class="total"><td>Totale netto EUR (incassato)</td><td>‚Ç¨${totNettoEUR.toFixed(2)}</td></tr>
          </table>
          
          <div class="info">
            <strong>üìù Da dichiarare nel Quadro RL:</strong> ‚Ç¨${totLordoEUR.toFixed(2)} (lordo)
          </div>
          
          <h2>Dettaglio Vendite</h2>
          <table>
            <tr><th>Data</th><th>Prodotto</th><th>Fonte</th><th>USD</th><th>EUR Lordo</th><th>EUR Netto</th></tr>
            ${sales.map(s => `
              <tr>
                <td>${formatDate(s.sale_date)}</td>
                <td>${s.ea_product}</td>
                <td>${s.source}</td>
                <td>$${s.amount_usd.toFixed(2)}</td>
                <td>‚Ç¨${s.amount_eur_gross.toFixed(2)}</td>
                <td>‚Ç¨${s.amount_eur_net.toFixed(2)}</td>
              </tr>
            `).join('')}
          </table>
          
          <p style="margin-top:40px;color:#666;font-size:12px;">
            ‚ö†Ô∏è Documento indicativo - Consultare un commercialista per la dichiarazione ufficiale
          </p>
          
          <button onclick="window.print()" style="margin-top:20px;padding:10px 20px;background:#f7931a;color:white;border:none;border-radius:5px;cursor:pointer;">
            üñ®Ô∏è Stampa / Salva PDF
          </button>
        </body>
        </html>
      `);
      reportWindow.document.close();
    }
    
    function clearAllData() {
      if (!confirm('‚ö†Ô∏è ATTENZIONE: Questa azione canceller√† TUTTI i dati (vendite e licenze). Sei sicuro?')) return;
      if (!confirm('üö® ULTIMA CONFERMA: Hai esportato un backup? Questa azione √® IRREVERSIBILE.')) return;
      
      showStatus('‚ö†Ô∏è Cancellazione massiva non implementata per sicurezza. Elimina i record singolarmente.', true);
    }
    
    // ==================== ACTIVATION CODES ====================
    let codes = [];
    
    async function loadCodes() {
      try {
        const res = await fetch('/api/admin?type=codes', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        codes = await res.json();
        renderCodes();
      } catch (err) {
        console.error(err);
        showStatus('Errore caricamento codici', true);
      }
    }
    
    function renderCodes() {
      const tbody = $('codesTable');
      
      if (codes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:rgba(255,255,255,0.4);">Nessun codice creato</td></tr>';
        updateCodeStats();
        return;
      }
      
      const baseUrl = window.location.origin;
      
      tbody.innerHTML = codes.map(c => {
        const typeLabel = c.license_type === 'trial' ? '‚è±Ô∏è Trial' : (c.license_type === 'free' ? 'üéÅ Free' : 'üí∞ Paid');
        const typeClass = 'type-' + c.license_type;
        const statusLabel = c.used ? '<span style="color:#6b7280;">‚úì Usato</span>' : '<span style="color:#22c55e;">‚úÖ Disponibile</span>';
        const days = c.trial_days || '-';
        const platform = c.platform || 'MT5';
        const link = `${baseUrl}/activate.html?code=${c.code}`;
        
        return `
        <tr>
          <td class="mono" style="font-weight:600;color:#00FF41;">${c.code}</td>
          <td>${c.product.replace('_', ' ')}</td>
          <td><span class="source-badge" style="background:rgba(59,130,246,0.15);color:#3b82f6;">${platform}</span></td>
          <td><span class="source-badge ${typeClass}">${typeLabel}</span></td>
          <td>${days}</td>
          <td>${statusLabel}</td>
          <td>
            ${c.used ? `<span style="color:#6b7280;font-size:12px;">${c.used_by_name || ''}</span>` : 
              `<button class="btn btn-secondary" style="padding:4px 8px;font-size:11px;" onclick="copyLink('${link}')">üìã Copia Link</button>`}
          </td>
          <td><button class="btn btn-danger" onclick="deleteCode(${c.id})">üóëÔ∏è</button></td>
        </tr>
      `}).join('');
      
      updateCodeStats();
    }
    
    function updateCodeStats() {
      const available = codes.filter(c => !c.used);
      const used = codes.filter(c => c.used);
      
      $('statTotaleCodes').textContent = codes.length;
      $('statAvailableCodes').textContent = available.length;
      $('statUsedCodes').textContent = used.length;
    }
    
    function toggleCodeForm() {
      const form = $('codeForm');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'block') {
        $('codeType').value = 'trial';
        $('codeTrialDays').value = '30';
        toggleCodeTrialDays();
      }
    }
    
    function toggleCodeTrialDays() {
      const isTrial = $('codeType').value === 'trial';
      $('codeTrialDaysGroup').style.display = isTrial ? 'block' : 'none';
    }
    
    async function createCode() {
      const codeData = {
        product: $('codeProduct').value,
        platform: $('codePlatform').value,
        license_type: $('codeType').value,
        trial_days: parseInt($('codeTrialDays').value) || 30
      };
      
      try {
        const res = await fetch('/api/admin?type=codes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify(codeData)
        });
        
        if (res.ok) {
          const data = await res.json();
          showStatus(`‚úÖ Codice creato: ${data.code.code}`);
          toggleCodeForm();
          loadCodes();
        } else {
          showStatus('Errore creazione codice', true);
        }
      } catch (err) {
        showStatus('Errore di rete', true);
      }
    }
    
    async function deleteCode(id) {
      if (!confirm('Eliminare questo codice?')) return;
      
      try {
        const res = await fetch(`/api/admin?type=codes&id=${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        
        if (res.ok) {
          showStatus('‚úÖ Codice eliminato');
          loadCodes();
        }
      } catch (err) {
        showStatus('Errore eliminazione', true);
      }
    }
    
    function copyLink(link) {
      navigator.clipboard.writeText(link);
      showStatus('‚úÖ Link copiato negli appunti!');
    }
    
    // ==================== SETTINGS ====================
    async function loadSettings() {
      try {
        const res = await fetch('/api/admin?type=settings', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        });
        if (res.ok) {
          const data = await res.json();
          if (data.settings) {
            $('priceXAU').value = data.settings.price_xau || 499;
            $('priceBTC').value = data.settings.price_btc || 499;
          }
        }
      } catch (err) {
        console.log('Settings not found, using defaults');
      }
      
      // Set buy link
      const baseUrl = window.location.origin;
      $('buyLink').value = `${baseUrl}/buy.html`;
    }
    
    async function saveSettings() {
      const settings = {
        price_xau: parseInt($('priceXAU').value) || 499,
        price_btc: parseInt($('priceBTC').value) || 499
      };
      
      try {
        const res = await fetch('/api/admin?type=settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify(settings)
        });
        
        if (res.ok) {
          showStatus('‚úÖ Prezzi salvati!');
        } else {
          showStatus('Errore salvataggio', true);
        }
      } catch (err) {
        showStatus('Errore di rete', true);
      }
    }
    
    function copyBuyLink() {
      const link = $('buyLink').value;
      navigator.clipboard.writeText(link);
      showStatus('‚úÖ Link copiato!');
    }
    
    // ==================== IMPORT MQL5 JSON ====================
    async function importMQL5JSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!data.vendite || !Array.isArray(data.vendite)) {
            showStatus('Formato JSON non valido', true);
            return;
          }
          
          let imported = 0;
          let errors = 0;
          
          for (const v of data.vendite) {
            // Determina il prodotto dal nome
            let ea_product = 'BTC_AutoTrader';
            const nome = v.nomeEA.toLowerCase();
            
            if (nome.includes('signal') || nome.includes('subscription')) {
              if (nome.includes('xau')) {
                ea_product = 'XAU_Signal';
              } else {
                ea_product = 'BTC_Signal';
              }
            } else if (nome.includes('xau')) {
              ea_product = 'XAU_AutoTrader';
            } else {
              ea_product = 'BTC_AutoTrader';
            }
            
            const saleData = {
              sale_date: v.data,
              ea_product: ea_product,
              source: 'market',
              amount_usd: v.importoUSD,
              exchange_rate: v.cambioEUR,
              notes: v.nomeEA.trim()
            };
            
            try {
              const res = await fetch('/api/admin?type=sales', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${adminPassword}`
                },
                body: JSON.stringify(saleData)
              });
              
              if (res.ok) {
                imported++;
              } else {
                errors++;
              }
            } catch {
              errors++;
            }
          }
          
          showStatus(`‚úÖ Importate ${imported} vendite` + (errors > 0 ? ` (${errors} errori)` : ''));
          loadSales();
          
        } catch (err) {
          showStatus('Errore parsing JSON: ' + err.message, true);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    // ==================== UTILS ====================
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('it-IT');
    }
    
    // ==================== INIT ====================
    window.onload = () => {
      // Set current year
      const currentYear = new Date().getFullYear();
      $('salesYear').value = currentYear;
      $('taxYear').value = currentYear;
      $('exportYear').value = currentYear;
      
      // Check saved password
      const saved = localStorage.getItem('eaDashPwd');
      if (saved) {
        adminPassword = saved;
        fetch('/api/admin?type=licenses', {
          headers: { 'Authorization': `Bearer ${adminPassword}` }
        }).then(res => {
          if (res.ok) {
            $('loginPanel').classList.remove('active');
            $('mainPanel').classList.add('active');
            loadSales();
            loadLicenses();
          } else {
            localStorage.removeItem('eaDashPwd');
          }
        }).catch(() => {
          localStorage.removeItem('eaDashPwd');
        });
      }
    };
    
    // ==================== MT5 FISCAL ANALYZER ====================
    
    // Dati MT5
    let mt5Accounts = [];
    let mt5YearlyData = {};
    
    // Cambi medi EUR/USD ufficiali (fonte BCE)
    const defaultExchangeRates = {
      2021: 1.1827,
      2022: 1.0530,
      2023: 1.0813,
      2024: 1.0813,
      2025: 1.0850,
      2026: 1.0900,
      2027: 1.0900,
      2028: 1.0900,
      2029: 1.0900,
      2030: 1.0900
    };
    
    let mt5ExchangeRates = { ...defaultExchangeRates };
    
    // Broker e paesi
    const brokerCountries = {
      'ic markets': { code: '036', name: 'Australia' },
      'icmarkets': { code: '036', name: 'Australia' },
      'raw trading': { code: '248', name: 'Seychelles' },
      'pepperstone': { code: '036', name: 'Australia' },
      'fpmarkets': { code: '036', name: 'Australia' },
      'fp markets': { code: '036', name: 'Australia' },
      'vantage': { code: '036', name: 'Australia' },
      'fxpro': { code: '196', name: 'Cipro' },
      'xm': { code: '196', name: 'Cipro' },
      'exness': { code: '196', name: 'Cipro' },
      'roboforex': { code: '196', name: 'Cipro' },
      'fxtm': { code: '196', name: 'Cipro' },
      'hotforex': { code: '196', name: 'Cipro' },
      'hfm': { code: '196', name: 'Cipro' },
      'tickmill': { code: '826', name: 'Regno Unito' },
      'fxcm': { code: '826', name: 'Regno Unito' },
      'oanda': { code: '826', name: 'Regno Unito' },
      'ig': { code: '826', name: 'Regno Unito' },
      'admirals': { code: '372', name: 'Estonia' },
      'admiral markets': { code: '372', name: 'Estonia' },
      'default': { code: '196', name: 'Cipro' }
    };
    
    // Setup drag & drop
    document.addEventListener('DOMContentLoaded', () => {
      const dropZone = document.getElementById('mt5DropZone');
      if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('active');
        });
        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('active');
        });
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('active');
          handleMT5Files({ target: { files: e.dataTransfer.files } });
        });
      }
    });
    
    async function handleMT5Files(event) {
      const files = Array.from(event.target.files);
      const dropZone = document.getElementById('mt5DropZone');
      
      dropZone.innerHTML = '<div style="font-size:48px;">‚è≥</div><p>Elaborazione in corso...</p>';
      
      for (const file of files) {
        if (file.name.match(/\.xlsx?$/i)) {
          try {
            const data = await processMT5File(file);
            mt5Accounts.push(data);
          } catch (e) {
            console.error('Errore file:', file.name, e);
          }
        }
      }
      
      dropZone.innerHTML = '<div style="font-size:48px;">üìÅ</div><p>Trascina altri file o clicca</p><p style="color:rgba(255,255,255,0.4);font-size:12px;margin-top:8px;">‚úÖ ' + mt5Accounts.length + ' account caricati</p>';
      
      if (mt5Accounts.length > 0) {
        document.getElementById('mt5CurrencySettings').style.display = 'block';
        consolidateMT5Data();
        renderMT5Results();
      }
    }
    
    async function processMT5File(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const wb = XLSX.read(e.target.result, { type: 'array' });
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
            
            // Estrai info account
            let accountName = '', accountNumber = '', company = '', currency = 'USD';
            
            for (let i = 0; i < 15; i++) {
              const row = data[i] || [];
              const cell0 = String(row[0] || '');
              const cell3 = String(row[3] || '');
              
              if (cell0 === 'Name:') accountName = cell3;
              if (cell0 === 'Account:') {
                const m = cell3.match(/(\d+)/);
                if (m) accountNumber = m[1];
                // Rileva valuta da Account: "7417632 (EUR, ICMarkets...)"
                if (cell3.includes('(EUR')) currency = 'EUR';
                else if (cell3.includes('(USD')) currency = 'USD';
              }
              if (cell0 === 'Company:') company = cell3;
            }
            
            // Trova broker/paese
            const companyLower = company.toLowerCase();
            let countryInfo = brokerCountries.default;
            for (const [broker, info] of Object.entries(brokerCountries)) {
              if (companyLower.includes(broker)) {
                countryInfo = info;
                break;
              }
            }
            
            // Trova sezione Positions (trade completi)
            let positionsStart = -1;
            for (let i = 0; i < data.length; i++) {
              if (data[i][0] === 'Positions') { 
                positionsStart = i + 2; // Salta header
                break; 
              }
            }
            
            // Processa trade dalla sezione Positions
            const trades = [];
            let grossProfit = 0, grossLoss = 0, wins = 0, losses = 0;
            let valoreIniziale = 0, valoreFinale = 0;
            
            if (positionsStart !== -1) {
              for (let i = positionsStart; i < data.length; i++) {
                const row = data[i];
                let dateStr = row[0];
                
                // Gestisci sia stringhe che oggetti Date
                let tradeDate;
                if (dateStr instanceof Date) {
                  tradeDate = dateStr;
                  dateStr = dateStr.toISOString();
                } else {
                  dateStr = String(dateStr || '');
                  // Stop se nuova sezione o riga vuota
                  if (!dateStr || (!dateStr.match(/^\d{4}[\.\-]/) && !dateStr.match(/^\d{2}[\.\-]/))) {
                    if (row[0] && ['Deals', 'Orders', 'Working Orders', 'Results'].includes(String(row[0]))) break;
                    continue;
                  }
                  tradeDate = new Date(dateStr.replace(/\./g, '-'));
                }
                
                // Verifica data valida
                if (!tradeDate || isNaN(tradeDate.getTime())) continue;
                
                try {
                  // Colonne Positions: Time, Position, Symbol, Type, Volume, Price, S/L, T/P, Time, Price, Commission, Swap, Profit
                  const profit = parseFloat(row[12]) || 0;
                  const symbol = String(row[2] || '');
                  const volume = parseFloat(String(row[4]).replace(',', '.')) || 0;
                  const tradeType = String(row[3] || '').toLowerCase();
                  
                  if (symbol && (tradeType === 'buy' || tradeType === 'sell')) {
                    trades.push({
                      date: tradeDate,
                      profit: profit,
                      symbol: symbol,
                      volume: volume
                    });
                    
                    if (profit > 0) {
                      grossProfit += profit;
                      wins++;
                    } else if (profit < 0) {
                      grossLoss += profit;
                      losses++;
                    }
                  }
                } catch (e) {
                  console.error('Errore riga:', i, e);
                }
              }
            }
            
            // Se non trova Positions, prova con Deals (formato alternativo)
            if (trades.length === 0) {
              let dealsStart = -1;
              for (let i = 0; i < data.length; i++) {
                if (data[i][0] === 'Deals') { dealsStart = i + 2; break; }
              }
              
              if (dealsStart !== -1) {
                for (let i = dealsStart; i < data.length; i++) {
                  const row = data[i];
                  let dateVal = row[0];
                  
                  // Gestisci sia stringhe che oggetti Date
                  let tradeDate;
                  if (dateVal instanceof Date) {
                    tradeDate = dateVal;
                  } else {
                    const dateStr = String(dateVal || '');
                    if (!dateStr.match(/^\d{4}[\.\-]/) && !dateStr.match(/^\d{2}[\.\-]/)) {
                      if (row[0] && ['Orders', 'Positions', 'Working Orders'].includes(String(row[0]))) break;
                      continue;
                    }
                    tradeDate = new Date(dateStr.replace(/\./g, '-'));
                  }
                  
                  if (!tradeDate || isNaN(tradeDate.getTime())) continue;
                  
                  try {
                    const profit = parseFloat(row[11]) || 0;
                    const type = String(row[3] || '').toLowerCase();
                    const direction = String(row[4] || '').toLowerCase();
                    const symbol = String(row[2] || '');
                    
                    // Solo trade chiusi (direction = 'out')
                    if (symbol && (type === 'buy' || type === 'sell') && direction === 'out') {
                      trades.push({
                        date: tradeDate,
                        profit: profit,
                        symbol: symbol,
                        volume: parseFloat(row[5]) || 0
                      });
                      
                      if (profit > 0) {
                        grossProfit += profit;
                        wins++;
                      } else if (profit < 0) {
                        grossLoss += profit;
                        losses++;
                      }
                    }
                  } catch (e) {
                    console.error('Errore deals:', e);
                  }
                }
              }
            }
            
            // Calcola valore iniziale/finale da Deals (balance)
            let dealsStart = -1;
            for (let i = 0; i < data.length; i++) {
              if (data[i][0] === 'Deals') { dealsStart = i + 2; break; }
            }
            
            if (dealsStart !== -1) {
              let firstBalance = null, lastBalance = null;
              for (let i = dealsStart; i < data.length; i++) {
                const row = data[i];
                const balance = parseFloat(row[12]) || 0;
                if (balance > 0) {
                  if (firstBalance === null) firstBalance = balance;
                  lastBalance = balance;
                }
              }
              valoreIniziale = firstBalance || 0;
              valoreFinale = lastBalance || 0;
            }
            
            resolve({
              accountName,
              accountNumber,
              company,
              currency,
              countryInfo,
              trades,
              grossProfit,
              grossLoss,
              netProfit: grossProfit + grossLoss,
              wins,
              losses,
              valoreIniziale,
              valoreFinale,
              minDate: trades.length > 0 ? trades[0].date : null,
              maxDate: trades.length > 0 ? trades[trades.length - 1].date : null,
              fileName: file.name
            });
            
          } catch (e) {
            console.error('Errore parsing:', e);
            reject(e);
          }
        };
        reader.onerror = () => reject(new Error('Errore lettura file'));
        reader.readAsArrayBuffer(file);
      });
    }
    
    function consolidateMT5Data() {
      mt5YearlyData = {};
      const yearsFound = new Set();
      
      mt5Accounts.forEach(acc => {
        acc.trades.forEach(trade => {
          const year = trade.date.getFullYear();
          yearsFound.add(year);
          
          if (!mt5YearlyData[year]) {
            mt5YearlyData[year] = {
              accounts: {},
              totals: {
                trades: 0, wins: 0, losses: 0,
                grossProfit: 0, grossLoss: 0, netProfit: 0,
                valoreIniziale: 0, valoreFinale: 0, ivafe: 0
              }
            };
          }
          
          const accKey = acc.accountNumber;
          if (!mt5YearlyData[year].accounts[accKey]) {
            mt5YearlyData[year].accounts[accKey] = {
              accountName: acc.accountName,
              accountNumber: acc.accountNumber,
              company: acc.company,
              currency: acc.currency,
              countryInfo: acc.countryInfo,
              trades: 0, wins: 0, losses: 0,
              grossProfit: 0, grossLoss: 0, netProfit: 0,
              valoreIniziale: acc.valoreIniziale,
              valoreFinale: 0,
              giorni: 0,
              ivafe: 0
            };
          }
          
          const yearAcc = mt5YearlyData[year].accounts[accKey];
          yearAcc.trades++;
          if (trade.profit > 0) {
            yearAcc.grossProfit += trade.profit;
            yearAcc.wins++;
          } else {
            yearAcc.grossLoss += trade.profit;
            yearAcc.losses++;
          }
          yearAcc.netProfit = yearAcc.grossProfit + yearAcc.grossLoss;
          yearAcc.valoreFinale = acc.valoreFinale;
        });
      });
      
      // Calcola totali e IVAFE per ogni anno
      Object.keys(mt5YearlyData).forEach(year => {
        const data = mt5YearlyData[year];
        
        Object.values(data.accounts).forEach(acc => {
          // Converti in EUR se necessario
          const rate = acc.currency === 'USD' ? mt5ExchangeRates[year] || 1.08 : 1;
          acc.grossProfitEUR = acc.grossProfit / rate;
          acc.grossLossEUR = acc.grossLoss / rate;
          acc.netProfitEUR = acc.netProfit / rate;
          acc.valoreInizialeEUR = acc.valoreIniziale / rate;
          acc.valoreFinaleEUR = acc.valoreFinale / rate;
          
          // Giorni detenzione (approssimato a 365 se annuale)
          acc.giorni = 365;
          
          // IVAFE: 0.2% sul valore medio
          const valoreMedio = (acc.valoreInizialeEUR + acc.valoreFinaleEUR) / 2;
          acc.ivafe = valoreMedio * 0.002 * (acc.giorni / 365);
          
          // Aggiorna totali
          data.totals.trades += acc.trades;
          data.totals.wins += acc.wins;
          data.totals.losses += acc.losses;
          data.totals.grossProfit += acc.grossProfitEUR;
          data.totals.grossLoss += acc.grossLossEUR;
          data.totals.netProfit += acc.netProfitEUR;
          data.totals.valoreIniziale += acc.valoreInizialeEUR;
          data.totals.valoreFinale += acc.valoreFinaleEUR;
          data.totals.ivafe += acc.ivafe;
        });
      });
      
      // Aggiorna UI cambi
      renderMT5ExchangeRates(yearsFound);
    }
    
    function renderMT5ExchangeRates(years) {
      const container = document.getElementById('mt5ExchangeRates');
      container.innerHTML = '';
      
      const sortedYears = Array.from(years).sort();
      sortedYears.forEach(year => {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.minWidth = '120px';
        div.innerHTML = `
          <label>${year}</label>
          <input type="number" step="0.0001" value="${mt5ExchangeRates[year] || 1.08}" 
                 onchange="updateMT5ExchangeRate(${year}, this.value)" 
                 style="width:100%;">
        `;
        container.appendChild(div);
      });
    }
    
    function updateMT5ExchangeRate(year, value) {
      mt5ExchangeRates[year] = parseFloat(value) || 1.08;
      consolidateMT5Data();
      renderMT5Results();
    }
    
    function resetMT5ExchangeRates() {
      mt5ExchangeRates = { ...defaultExchangeRates };
      consolidateMT5Data();
      renderMT5Results();
    }
    
    function renderMT5Results() {
      document.getElementById('mt5Results').style.display = 'block';
      
      // Totali globali
      let totalTrades = 0, totalProfit = 0, totalIVAFE = 0, totalRT = 0;
      Object.values(mt5YearlyData).forEach(data => {
        totalTrades += data.totals.trades;
        totalProfit += data.totals.netProfit;
        totalIVAFE += data.totals.ivafe;
        if (data.totals.netProfit > 0) {
          totalRT += data.totals.netProfit * 0.26;
        }
      });
      
      document.getElementById('mt5TotalStats').innerHTML = `
        <div class="stat-card">
          <div class="stat-number orange">${mt5Accounts.length}</div>
          <div class="stat-label">Account</div>
        </div>
        <div class="stat-card">
          <div class="stat-number blue">${totalTrades}</div>
          <div class="stat-label">Trade Totali</div>
        </div>
        <div class="stat-card">
          <div class="stat-number ${totalProfit >= 0 ? 'green' : 'red'}">‚Ç¨${totalProfit.toFixed(0)}</div>
          <div class="stat-label">Profitto Netto</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" style="color:#ef4444;">‚Ç¨${totalRT.toFixed(0)}</div>
          <div class="stat-label">Imposta RT (26%)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" style="color:#fbbf24;">‚Ç¨${totalIVAFE.toFixed(0)}</div>
          <div class="stat-label">IVAFE (0.2%)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" style="color:#a855f7;">‚Ç¨${(totalRT + totalIVAFE).toFixed(0)}</div>
          <div class="stat-label">Totale Imposte</div>
        </div>
      `;
      
      // Dettaglio per anno
      const yearlyContainer = document.getElementById('mt5YearlyResults');
      yearlyContainer.innerHTML = '';
      
      Object.keys(mt5YearlyData).sort().forEach(year => {
        const data = mt5YearlyData[year];
        const t = data.totals;
        const impostaRT = t.netProfit > 0 ? t.netProfit * 0.26 : 0;
        
        let accountsHTML = '';
        Object.values(data.accounts).forEach(acc => {
          const impAcc = acc.netProfitEUR > 0 ? acc.netProfitEUR * 0.26 : 0;
          accountsHTML += `
            <div class="mt5-account-row">
              <div class="mt5-stat">
                <div class="label">Account</div>
                <div class="value">${acc.accountNumber}</div>
              </div>
              <div class="mt5-stat">
                <div class="label">Broker</div>
                <div class="value">${acc.company.substring(0, 15)}</div>
              </div>
              <div class="mt5-stat">
                <div class="label">Valuta</div>
                <div class="value">${acc.currency}</div>
              </div>
              <div class="mt5-stat">
                <div class="label">Trade</div>
                <div class="value">${acc.trades}</div>
              </div>
              <div class="mt5-stat">
                <div class="label">Profitto</div>
                <div class="value ${acc.netProfitEUR >= 0 ? 'mt5-profit' : 'mt5-loss'}">‚Ç¨${acc.netProfitEUR.toFixed(2)}</div>
              </div>
              <div class="mt5-stat">
                <div class="label">RT 26%</div>
                <div class="value mt5-loss">‚Ç¨${impAcc.toFixed(2)}</div>
              </div>
              <div class="mt5-stat">
                <div class="label">IVAFE</div>
                <div class="value" style="color:#fbbf24;">‚Ç¨${acc.ivafe.toFixed(2)}</div>
              </div>
            </div>
          `;
        });
        
        yearlyContainer.innerHTML += `
          <div class="mt5-year-card">
            <div class="mt5-year-header">
              <div class="mt5-year-badge">${year}</div>
              <div>
                <button class="btn btn-secondary btn-small" onclick="genMT5RT(${year})">üìÑ Quadro RT</button>
                <button class="btn btn-secondary btn-small" onclick="genMT5RW(${year})">üìÑ Quadro RW</button>
              </div>
            </div>
            ${accountsHTML}
            <div class="mt5-info-box">
              <strong>Riepilogo ${year}:</strong> 
              ${t.trades} trade | 
              Profitto: ‚Ç¨${t.netProfit.toFixed(2)} | 
              Imposta RT: ‚Ç¨${impostaRT.toFixed(2)} | 
              IVAFE: ‚Ç¨${t.ivafe.toFixed(2)} |
              <strong>Totale: ‚Ç¨${(impostaRT + t.ivafe).toFixed(2)}</strong>
            </div>
          </div>
        `;
      });
    }
    
    function genMT5RT(year) {
      const data = mt5YearlyData[year];
      if (!data) return;
      
      const t = data.totals;
      const imposta = t.netProfit > 0 ? t.netProfit * 0.26 : 0;
      
      let accountsHTML = '';
      Object.values(data.accounts).forEach(acc => {
        const impAcc = acc.netProfitEUR > 0 ? acc.netProfitEUR * 0.26 : 0;
        accountsHTML += `
          <tr>
            <td>${acc.accountNumber}</td>
            <td>${acc.company}</td>
            <td>${acc.currency}</td>
            <td style="text-align:right;">‚Ç¨${acc.grossProfitEUR.toFixed(2)}</td>
            <td style="text-align:right;">‚Ç¨${Math.abs(acc.grossLossEUR).toFixed(2)}</td>
            <td style="text-align:right;font-weight:bold;color:${acc.netProfitEUR >= 0 ? '#22c55e' : '#ef4444'};">‚Ç¨${acc.netProfitEUR.toFixed(2)}</td>
            <td style="text-align:right;color:#ef4444;">‚Ç¨${impAcc.toFixed(2)}</td>
          </tr>
        `;
      });
      
      const reportHTML = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8">
        <title>Quadro RT ${year}</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script>
        <style>
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; color: #1a1a1a; line-height: 1.6; }
          .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #3b82f6; }
          .header h1 { font-size: 28px; color: #1e40af; margin-bottom: 8px; }
          .header .subtitle { color: #666; font-size: 14px; }
          .section { margin-bottom: 32px; background: #f8fafc; border-radius: 12px; padding: 24px; }
          .section h2 { font-size: 16px; color: #3b82f6; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
          .highlight { background: linear-gradient(135deg, #fee2e2, #fecaca); border: 2px solid #ef4444; padding: 20px; border-radius: 12px; margin: 24px 0; text-align: center; }
          .highlight .label { font-size: 14px; color: #666; }
          .highlight .value { font-size: 36px; color: #dc2626; font-weight: 700; }
          table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
          th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
          th { background: #e2e8f0; font-weight: 600; font-size: 11px; text-transform: uppercase; }
          .row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e2e8f0; }
          .row:last-child { border-bottom: none; }
          .info-box { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 16px; margin-top: 24px; font-size: 13px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #888; }
          .btn-group { text-align: center; margin: 20px 0; }
          .btn { padding: 12px 24px; margin: 0 8px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
          .btn-primary { background: #3b82f6; color: white; }
          .btn-secondary { background: #64748b; color: white; }
          .btn:hover { opacity: 0.9; }
          @media print { .btn-group { display: none; } body { padding: 20px; } }
        </style></head><body>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="scaricaPDF()">üì• Scarica PDF</button>
          <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Stampa</button>
        </div>
        <div id="report-content">
          <div class="header">
            <h1>üìä QUADRO RT - PLUSVALENZE FINANZIARIE</h1>
            <div class="subtitle">Anno d'imposta ${year} ‚Ä¢ Generato il ${new Date().toLocaleDateString('it-IT')}</div>
          </div>
          
          <div class="section">
            <h2>üìã Riepilogo Operazioni</h2>
            <div class="row"><span>Totale Corrispettivi (RT21)</span><span style="font-weight:600;">‚Ç¨${(t.grossProfit + Math.abs(t.grossLoss)).toFixed(2)}</span></div>
            <div class="row"><span>Totale Costi (RT22)</span><span style="font-weight:600;">‚Ç¨${Math.abs(t.grossLoss).toFixed(2)}</span></div>
            <div class="row"><span>Plusvalenza Netta (RT23)</span><span style="font-weight:600;color:${t.netProfit >= 0 ? '#22c55e' : '#ef4444'};">‚Ç¨${t.netProfit.toFixed(2)}</span></div>
          </div>
          
          <div class="highlight">
            <div class="label">IMPOSTA SOSTITUTIVA 26% (RT26)</div>
            <div class="value">‚Ç¨${imposta.toFixed(2)}</div>
          </div>
          
          <div class="section">
            <h2>üìë Dettaglio per Account</h2>
            <table>
              <thead><tr><th>Account</th><th>Broker</th><th>Valuta</th><th>Profitti</th><th>Perdite</th><th>Netto</th><th>Imposta</th></tr></thead>
              <tbody>${accountsHTML}</tbody>
            </table>
          </div>
          
          <div class="info-box">
            <strong>üìù Istruzioni per la compilazione:</strong>
            <ul style="margin-top:8px;margin-left:20px;">
              <li>Compilare il <strong>Quadro RT</strong> del Modello Redditi PF</li>
              <li>Le plusvalenze da trading con broker esteri sono soggette a imposta sostitutiva del 26%</li>
              <li>Le minusvalenze possono essere compensate nei 4 anni successivi</li>
              <li>Codice Stato: vedere Quadro RW per dettaglio paesi</li>
            </ul>
          </div>
          
          <div class="footer">
            <p>Report generato da EA Business Dashboard</p>
            <p>‚ö†Ô∏è Documento indicativo - Consultare un commercialista per la dichiarazione ufficiale</p>
          </div>
        </div>
        <script>
          function scaricaPDF() {
            var element = document.getElementById("report-content");
            var opt = { margin: 10, filename: "Quadro_RT_${year}.pdf", image: { type: "jpeg", quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: "mm", format: "a4", orientation: "portrait" } };
            html2pdf().set(opt).from(element).save();
          }
        <\/script>
      </body></html>`;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(reportHTML);
      printWindow.document.close();
    }
    
    function genMT5RW(year) {
      const data = mt5YearlyData[year];
      if (!data) return;
      
      let accountsHTML = '';
      Object.values(data.accounts).forEach((acc, idx) => {
        accountsHTML += `
          <div style="background:#f0fdf4;border:2px solid #22c55e;border-radius:12px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#16a34a;margin-bottom:12px;">Account #${idx + 1}: ${acc.accountNumber}</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:14px;">
              <div><strong>Broker:</strong> ${acc.company}</div>
              <div><strong>Paese:</strong> ${acc.countryInfo.name} (Codice: ${acc.countryInfo.code})</div>
              <div><strong>Valuta conto:</strong> ${acc.currency}</div>
              <div><strong>Giorni detenzione:</strong> ${acc.giorni}</div>
              <div><strong>Valore Iniziale:</strong> ‚Ç¨${acc.valoreInizialeEUR.toFixed(2)}</div>
              <div><strong>Valore Finale:</strong> ‚Ç¨${acc.valoreFinaleEUR.toFixed(2)}</div>
            </div>
            <div style="margin-top:16px;padding-top:12px;border-top:1px solid #bbf7d0;text-align:right;">
              <span style="font-size:18px;font-weight:700;color:#ca8a04;">IVAFE: ‚Ç¨${acc.ivafe.toFixed(2)}</span>
            </div>
          </div>
        `;
      });
      
      const reportHTML = `<!DOCTYPE html><html lang="it"><head><meta charset="UTF-8">
        <title>Quadro RW ${year}</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script>
        <style>
          * { box-sizing: border-box; margin: 0; padding: 0; }
          body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; color: #1a1a1a; line-height: 1.6; }
          .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid #22c55e; }
          .header h1 { font-size: 28px; color: #16a34a; margin-bottom: 8px; }
          .header .subtitle { color: #666; font-size: 14px; }
          .section { margin-bottom: 32px; }
          .section h2 { font-size: 16px; color: #16a34a; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; }
          .highlight { background: linear-gradient(135deg, #fef9c3, #fef08a); border: 2px solid #eab308; padding: 20px; border-radius: 12px; margin: 24px 0; text-align: center; }
          .highlight .label { font-size: 14px; color: #666; }
          .highlight .value { font-size: 36px; color: #ca8a04; font-weight: 700; }
          .info-box { background: #f0fdf4; border-left: 4px solid #22c55e; padding: 16px; margin-top: 24px; font-size: 13px; }
          .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #888; }
          .btn-group { text-align: center; margin: 20px 0; }
          .btn { padding: 12px 24px; margin: 0 8px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
          .btn-primary { background: #22c55e; color: white; }
          .btn-secondary { background: #64748b; color: white; }
          .btn:hover { opacity: 0.9; }
          @media print { .btn-group { display: none; } body { padding: 20px; } }
        </style></head><body>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="scaricaPDF()">üì• Scarica PDF</button>
          <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Stampa</button>
        </div>
        <div id="report-content">
          <div class="header">
            <h1>üåç QUADRO RW - MONITORAGGIO FISCALE</h1>
            <div class="subtitle">Anno d'imposta ${year} ‚Ä¢ Generato il ${new Date().toLocaleDateString('it-IT')}</div>
          </div>
          
          <div class="section">
            <h2>üìë Dettaglio Conti Esteri</h2>
            ${accountsHTML}
          </div>
          
          <div class="highlight">
            <div class="label">TOTALE IVAFE ${year}</div>
            <div class="value">‚Ç¨${data.totals.ivafe.toFixed(2)}</div>
          </div>
          
          <div class="info-box">
            <strong>üìù Istruzioni per la compilazione Quadro RW:</strong>
            <ul style="margin-top:8px;margin-left:20px;">
              <li><strong>Codice investimento:</strong> 14 (Altri strumenti finanziari)</li>
              <li><strong>IVAFE:</strong> 0.2% sul valore medio annuo (proporzionato ai giorni)</li>
              <li><strong>Obbligo monitoraggio:</strong> Attivit√† finanziarie estere > ‚Ç¨15.000 valore massimo</li>
              <li><strong>Compilare:</strong> Un rigo per ogni conto/broker estero</li>
            </ul>
          </div>
          
          <div class="footer">
            <p>Report generato da EA Business Dashboard</p>
            <p>‚ö†Ô∏è Documento indicativo - Consultare un commercialista per la dichiarazione ufficiale</p>
          </div>
        </div>
        <script>
          function scaricaPDF() {
            var element = document.getElementById("report-content");
            var opt = { margin: 10, filename: "Quadro_RW_${year}.pdf", image: { type: "jpeg", quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: "mm", format: "a4", orientation: "portrait" } };
            html2pdf().set(opt).from(element).save();
          }
        <\/script>
      </body></html>`;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(reportHTML);
      printWindow.document.close();
    }
    
    function exportAllMT5PDF() {
      const years = Object.keys(mt5YearlyData).sort();
      let delay = 0;
      
      years.forEach(year => {
        setTimeout(() => downloadMT5RT(parseInt(year)), delay);
        delay += 1000;
        setTimeout(() => downloadMT5RW(parseInt(year)), delay);
        delay += 1000;
      });
      
      setTimeout(() => {
        showStatus(`‚úÖ Generati ${years.length * 2} PDF (RT + RW) per: ${years.join(', ')}`);
      }, delay);
    }
    
    // Funzioni download diretto (senza anteprima)
    function downloadMT5RT(year) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = mt5YearlyData[year];
      if (!data) return;
      
      const t = data.totals;
      const imposta = t.netProfit > 0 ? t.netProfit * 0.26 : 0;
      
      // Header
      doc.setFontSize(20);
      doc.setTextColor(30, 64, 175);
      doc.text('QUADRO RT - PLUSVALENZE FINANZIARIE', 105, 25, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(`Anno d'imposta: ${year} - Generato il ${new Date().toLocaleDateString('it-IT')}`, 105, 35, { align: 'center' });
      
      // Box riepilogo
      doc.setFillColor(248, 250, 252);
      doc.roundedRect(15, 45, 180, 45, 3, 3, 'F');
      
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
      doc.text(`Totale Corrispettivi (RT21): ‚Ç¨${(t.grossProfit + Math.abs(t.grossLoss)).toFixed(2)}`, 25, 58);
      doc.text(`Totale Costi (RT22): ‚Ç¨${Math.abs(t.grossLoss).toFixed(2)}`, 25, 70);
      doc.text(`Plusvalenza Netta (RT23): ‚Ç¨${t.netProfit.toFixed(2)}`, 25, 82);
      
      // Box imposta
      doc.setFillColor(254, 226, 226);
      doc.setDrawColor(239, 68, 68);
      doc.roundedRect(15, 98, 180, 30, 3, 3, 'FD');
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text('IMPOSTA SOSTITUTIVA 26% (RT26)', 105, 110, { align: 'center' });
      
      doc.setFontSize(24);
      doc.setTextColor(220, 38, 38);
      doc.text(`‚Ç¨${imposta.toFixed(2)}`, 105, 122, { align: 'center' });
      
      // Tabella account
      let y = 145;
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text('DETTAGLIO PER ACCOUNT', 15, y);
      y += 10;
      
      // Header tabella
      doc.setFillColor(226, 232, 240);
      doc.rect(15, y - 5, 180, 8, 'F');
      doc.setFontSize(9);
      doc.text('Account', 18, y);
      doc.text('Broker', 50, y);
      doc.text('Valuta', 100, y);
      doc.text('Profitto', 125, y);
      doc.text('Netto', 155, y);
      doc.text('Imposta', 180, y);
      y += 10;
      
      // Righe account
      doc.setFontSize(9);
      Object.values(data.accounts).forEach(acc => {
        const impAcc = acc.netProfitEUR > 0 ? acc.netProfitEUR * 0.26 : 0;
        doc.text(acc.accountNumber, 18, y);
        doc.text(acc.company.substring(0, 20), 50, y);
        doc.text(acc.currency, 100, y);
        doc.text(`‚Ç¨${acc.grossProfitEUR.toFixed(2)}`, 125, y);
        doc.text(`‚Ç¨${acc.netProfitEUR.toFixed(2)}`, 155, y);
        doc.text(`‚Ç¨${impAcc.toFixed(2)}`, 180, y);
        y += 8;
      });
      
      // Footer
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('Documento indicativo - Consultare un commercialista per la dichiarazione ufficiale', 105, 280, { align: 'center' });
      
      doc.save(`Quadro_RT_${year}.pdf`);
    }
    
    function downloadMT5RW(year) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = mt5YearlyData[year];
      if (!data) return;
      
      // Header
      doc.setFontSize(20);
      doc.setTextColor(22, 163, 74);
      doc.text('QUADRO RW - MONITORAGGIO FISCALE', 105, 25, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(`Anno d'imposta: ${year} - Generato il ${new Date().toLocaleDateString('it-IT')}`, 105, 35, { align: 'center' });
      
      let y = 50;
      
      // Account boxes
      Object.values(data.accounts).forEach((acc, idx) => {
        doc.setFillColor(240, 253, 244);
        doc.setDrawColor(34, 197, 94);
        doc.roundedRect(15, y, 180, 45, 3, 3, 'FD');
        
        doc.setFontSize(12);
        doc.setTextColor(22, 101, 52);
        doc.text(`Account #${idx + 1}: ${acc.accountNumber}`, 20, y + 10);
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(`Broker: ${acc.company}`, 20, y + 20);
        doc.text(`Paese: ${acc.countryInfo.name} (Codice: ${acc.countryInfo.code})`, 20, y + 28);
        doc.text(`Valuta: ${acc.currency} | Giorni: ${acc.giorni}`, 20, y + 36);
        
        doc.text(`Valore Iniziale: ‚Ç¨${acc.valoreInizialeEUR.toFixed(2)}`, 110, y + 20);
        doc.text(`Valore Finale: ‚Ç¨${acc.valoreFinaleEUR.toFixed(2)}`, 110, y + 28);
        
        doc.setFontSize(12);
        doc.setTextColor(202, 138, 4);
        doc.text(`IVAFE: ‚Ç¨${acc.ivafe.toFixed(2)}`, 110, y + 38);
        
        y += 52;
      });
      
      // Box totale IVAFE
      doc.setFillColor(254, 249, 195);
      doc.setDrawColor(234, 179, 8);
      doc.roundedRect(15, y, 180, 25, 3, 3, 'FD');
      
      doc.setFontSize(12);
      doc.setTextColor(100, 100, 100);
      doc.text(`TOTALE IVAFE ${year}`, 105, y + 10, { align: 'center' });
      
      doc.setFontSize(18);
      doc.setTextColor(202, 138, 4);
      doc.text(`‚Ç¨${data.totals.ivafe.toFixed(2)}`, 105, y + 20, { align: 'center' });
      
      // Istruzioni
      y += 35;
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text('Istruzioni Quadro RW:', 15, y);
      doc.setFontSize(9);
      doc.text('‚Ä¢ Codice investimento: 14 (Altri strumenti finanziari)', 15, y + 8);
      doc.text('‚Ä¢ IVAFE: 0.2% sul valore medio annuo proporzionato ai giorni', 15, y + 15);
      doc.text('‚Ä¢ Obbligo monitoraggio per attivit√† finanziarie estere > ‚Ç¨15.000', 15, y + 22);
      
      // Footer
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('Documento indicativo - Consultare un commercialista per la dichiarazione ufficiale', 105, 280, { align: 'center' });
      
      doc.save(`Quadro_RW_${year}.pdf`);
    }
    
    function exportMT5CSV() {
      let csv = 'Anno,Account,Broker,Valuta,Trade,Profitto Lordo,Perdita,Profitto Netto EUR,Imposta RT,Val.Iniziale,Val.Finale,IVAFE\n';
      
      Object.entries(mt5YearlyData).sort().forEach(([year, data]) => {
        Object.values(data.accounts).forEach(acc => {
          const imposta = acc.netProfitEUR > 0 ? (acc.netProfitEUR * 0.26).toFixed(2) : '0.00';
          csv += `${year},${acc.accountNumber},"${acc.company}",${acc.currency},`;
          csv += `${acc.trades},${acc.grossProfitEUR.toFixed(2)},${Math.abs(acc.grossLossEUR).toFixed(2)},${acc.netProfitEUR.toFixed(2)},${imposta},`;
          csv += `${acc.valoreInizialeEUR.toFixed(2)},${acc.valoreFinaleEUR.toFixed(2)},${acc.ivafe.toFixed(2)}\n`;
        });
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `MT5_Fiscal_Report_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
      
      showStatus('‚úÖ CSV esportato!');
    }
    
    function clearMT5Data() {
      if (!confirm('Cancellare tutti i dati MT5 caricati?')) return;
      mt5Accounts = [];
      mt5YearlyData = {};
      document.getElementById('mt5Results').style.display = 'none';
      document.getElementById('mt5CurrencySettings').style.display = 'none';
      document.getElementById('mt5DropZone').innerHTML = '<div style="font-size:48px;">üìä</div><p>Trascina qui i report MT5 (.xlsx)</p><p style="color:rgba(255,255,255,0.4);font-size:12px;margin-top:8px;">üí° Genera il report da MT5: Toolbox ‚Üí Cronologia ‚Üí Tasto destro ‚Üí Report ‚Üí Excel</p>';
      showStatus('üóëÔ∏è Dati MT5 cancellati');
    }
  </script>
</body>
</html>
