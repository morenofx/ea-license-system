<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>License Manager - Admin Panel</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0a0a0f;
      color: #e6edf3;
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    h1 {
      color: #00FF41;
      margin-bottom: 2rem;
      font-size: 1.8rem;
    }

    /* Login */
    .login-box {
      background: #12121a;
      padding: 2rem;
      border-radius: 8px;
      border: 1px solid #333;
      max-width: 400px;
      margin: 4rem auto;
    }

    .login-box h2 {
      margin-bottom: 1.5rem;
      color: #00FF41;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: #7d8590;
      font-size: 0.9rem;
    }

    input, select {
      width: 100%;
      padding: 0.8rem;
      background: #0a0a0f;
      border: 1px solid #333;
      border-radius: 4px;
      color: #e6edf3;
      font-size: 1rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #00FF41;
    }

    button {
      padding: 0.8rem 1.5rem;
      background: #00FF41;
      color: #0a0a0f;
      border: none;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
    }

    button.danger {
      background: #ff4757;
      color: white;
    }

    button.danger:hover {
      box-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
    }

    /* Panel */
    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    /* Add Form */
    .add-form {
      background: #12121a;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #333;
      margin-bottom: 2rem;
    }

    .add-form h3 {
      margin-bottom: 1rem;
      color: #00FF41;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 1rem;
      align-items: end;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Table */
    .table-container {
      background: #12121a;
      border-radius: 8px;
      border: 1px solid #333;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #333;
    }

    th {
      background: #1a1a24;
      color: #00FF41;
      font-weight: 600;
    }

    tr:hover {
      background: rgba(0, 255, 65, 0.05);
    }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: #7d8590;
    }

    /* Status */
    .status {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      display: none;
    }

    .status.success {
      display: block;
      background: rgba(0, 255, 65, 0.1);
      border: 1px solid #00FF41;
      color: #00FF41;
    }

    .status.error {
      display: block;
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid #ff4757;
      color: #ff4757;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .logout-btn {
      background: transparent;
      border: 1px solid #7d8590;
      color: #7d8590;
    }

    .logout-btn:hover {
      border-color: #ff4757;
      color: #ff4757;
      box-shadow: none;
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #12121a;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #333;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #00FF41;
    }

    .stat-label {
      color: #7d8590;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Login -->
    <div id="loginPanel" class="panel active">
      <div class="login-box">
        <h2>üîê Admin Login</h2>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Enter admin password">
        </div>
        <button onclick="login()" style="width:100%; margin-top:1rem;">Login</button>
        <div id="loginError" class="status" style="margin-top:1rem;"></div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="panel">
      <div class="header">
        <h1>üîë License Manager</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <!-- Stats -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="totalLicenses">0</div>
          <div class="stat-label">Total Licenses</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="xauLicenses">0</div>
          <div class="stat-label">XAU_AutoTrader</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="btcLicenses">0</div>
          <div class="stat-label">BTC_AutoTrader</div>
        </div>
      </div>

      <div id="statusMsg" class="status"></div>

      <!-- Add Form -->
      <div class="add-form">
        <h3>‚ûï Add New License</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Account Number</label>
            <input type="text" id="accountNumber" placeholder="123456789">
          </div>
          <div class="form-group">
            <label>Client Name</label>
            <input type="text" id="clientName" placeholder="Mario Rossi">
          </div>
          <div class="form-group">
            <label>EA Product</label>
            <select id="eaProduct">
              <option value="XAU_AutoTrader">XAU_AutoTrader</option>
              <option value="BTC_AutoTrader">BTC_AutoTrader</option>
            </select>
          </div>
          <button onclick="addLicense()">Add</button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Account</th>
              <th>Client Name</th>
              <th>EA Product</th>
              <th>Created</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="licensesTable">
            <tr><td colspan="5" class="no-data">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    let adminPassword = '';
    let licenses = [];

    function login() {
      adminPassword = document.getElementById('password').value;
      if (!adminPassword) {
        showLoginError('Please enter password');
        return;
      }
      
      // Test the password by loading licenses
      loadLicenses()
        .then(() => {
          document.getElementById('loginPanel').classList.remove('active');
          document.getElementById('adminPanel').classList.add('active');
          localStorage.setItem('adminPwd', adminPassword);
        })
        .catch(() => {
          showLoginError('Invalid password');
        });
    }

    function logout() {
      adminPassword = '';
      localStorage.removeItem('adminPwd');
      document.getElementById('adminPanel').classList.remove('active');
      document.getElementById('loginPanel').classList.add('active');
      document.getElementById('password').value = '';
    }

    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.className = 'status error';
    }

    function showStatus(msg, isError = false) {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = `status ${isError ? 'error' : 'success'}`;
      setTimeout(() => el.className = 'status', 3000);
    }

    async function loadLicenses() {
      const res = await fetch('/api/admin', {
        headers: { 'Authorization': `Bearer ${adminPassword}` }
      });

      if (!res.ok) throw new Error('Unauthorized');

      const data = await res.json();
      licenses = data.licenses || [];
      renderTable();
      updateStats();
    }

    function renderTable() {
      const tbody = document.getElementById('licensesTable');
      
      if (licenses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No licenses yet. Add one above!</td></tr>';
        return;
      }

      tbody.innerHTML = licenses.map(lic => `
        <tr>
          <td><strong>${lic.account_number}</strong></td>
          <td>${lic.client_name}</td>
          <td>${lic.ea_product}</td>
          <td>${new Date(lic.created_at).toLocaleDateString()}</td>
          <td><button class="danger" onclick="deleteLicense(${lic.id})">Remove</button></td>
        </tr>
      `).join('');
    }

    function updateStats() {
      document.getElementById('totalLicenses').textContent = licenses.length;
      document.getElementById('xauLicenses').textContent = licenses.filter(l => l.ea_product === 'XAU_AutoTrader').length;
      document.getElementById('btcLicenses').textContent = licenses.filter(l => l.ea_product === 'BTC_AutoTrader').length;
    }

    async function addLicense() {
      const account_number = document.getElementById('accountNumber').value.trim();
      const client_name = document.getElementById('clientName').value.trim();
      const ea_product = document.getElementById('eaProduct').value;

      if (!account_number || !client_name) {
        showStatus('Please fill all fields', true);
        return;
      }

      try {
        const res = await fetch('/api/admin', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ account_number, client_name, ea_product })
        });

        const data = await res.json();

        if (!res.ok) {
          showStatus(data.error || 'Error adding license', true);
          return;
        }

        showStatus(`License added for ${client_name}`);
        document.getElementById('accountNumber').value = '';
        document.getElementById('clientName').value = '';
        loadLicenses();

      } catch (err) {
        showStatus('Network error', true);
      }
    }

    async function deleteLicense(id) {
      if (!confirm('Remove this license?')) return;

      try {
        const res = await fetch('/api/admin', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${adminPassword}`
          },
          body: JSON.stringify({ id })
        });

        if (!res.ok) {
          showStatus('Error removing license', true);
          return;
        }

        showStatus('License removed');
        loadLicenses();

      } catch (err) {
        showStatus('Network error', true);
      }
    }

    // Auto-login if saved
    window.onload = () => {
      const saved = localStorage.getItem('adminPwd');
      if (saved) {
        adminPassword = saved;
        loadLicenses()
          .then(() => {
            document.getElementById('loginPanel').classList.remove('active');
            document.getElementById('adminPanel').classList.add('active');
          })
          .catch(() => {
            localStorage.removeItem('adminPwd');
          });
      }
    };
  </script>
</body>
</html>
